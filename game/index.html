<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">éŠæˆ²</title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
    <div class="container">
        <!-- ç­‰å¾…ç•«é¢ -->
        <div id="waitingScreen" class="waiting-screen">
            <h1>ğŸ® ç­‰å¾…éŠæˆ²é–‹å§‹</h1>
            <p id="playerWelcome" style="font-size: 1.2em; color: #667eea; margin-bottom: 20px;"></p>

            <div id="connectionStatus" style="margin: 20px 0;">
                <div class="status-indicator online"></div>
                <span>å·²é€£æ¥åˆ°éŠæˆ²ä¼ºæœå™¨</span>
            </div>

            <div id="usersList" class="users-list">
                <h3>åƒèˆ‡è€…åˆ—è¡¨ <span id="playerCount" class="player-count">(0)</span></h3>
                <div id="usersContainer" class="users-container"></div>
                <div id="morePlayersIndicator" class="more-players hidden">
                    é‚„æœ‰æ›´å¤šç©å®¶...
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                <p style="color: #666;">ç­‰å¾…ç®¡ç†å“¡é–‹å§‹éŠæˆ²...</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">
                    é¡Œç›®å·²é è¼‰å®Œæˆï¼Œæ–·ç·šå¾Œå¯è‡ªå‹•é‡é€£
                </p>
            </div>
        </div>

        <!-- éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚ -->
        <div id="startCountdownScreen" class="hidden">
            <h1>ğŸš€ éŠæˆ²å³å°‡é–‹å§‹</h1>
            <div id="startCountdown" class="countdown">3</div>
            <p style="color: #666;">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
        </div>

        <!-- éŠæˆ²é€²è¡Œç•«é¢ -->
        <div id="gameScreen" class="game-screen hidden">
            <div id="gameHeader" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="questionCounter" style="color: #667eea; font-weight: bold;"></div>
                    <div id="playerScore" class="score-display">åˆ†æ•¸: 0</div>
                </div>
                <div id="gameTimer" class="timer">--</div>
            </div>

            <div id="questionContainer" class="question-container">
                <div id="questionText" class="question"></div>
                <div id="optionsContainer" class="options"></div>
            </div>

            <div id="answerStatus" style="margin-top: 20px; color: #666;">
                <span id="answerIndicator"></span>
            </div>
        </div>

        <!-- é¡Œç›®çµæœç•«é¢ -->
        <div id="resultsScreen" class="results-screen hidden">
            <h2>ğŸ“Š é¡Œç›®çµæœ</h2>

            <div id="answerResult" style="margin: 30px 0;">
                <div id="correctAnswerDisplay" style="margin-bottom: 15px;"></div>
                <div id="userAnswerDisplay"></div>
            </div>

            <div id="scoreUpdate" style="margin: 20px 0;">
                <div id="scoreGained" style="color: #667eea; font-weight: bold; font-size: 1.5em; margin-bottom: 15px;"></div>
                <div id="currentScore" class="score-display"></div>
                <div id="currentRank" class="rank-display"></div>
                <div id="rankGap" style="color: #999; font-size: 14px;"></div>
            </div>

            <div id="miniLeaderboard" class="leaderboard">
                <h3>ç•¶å‰æ’è¡Œæ¦œ</h3>
                <div id="leaderboardContainer"></div>
            </div>

            <div style="margin-top: 20px; color: #666;">
                ç­‰å¾…é€²å…¥ä¸‹ä¸€é¡Œ...
            </div>
        </div>

        <!-- ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚ -->
        <div id="nextQuestionScreen" class="hidden">
            <h2>â¡ï¸ ä¸‹ä¸€é¡Œæº–å‚™ä¸­</h2>
            <div id="nextCountdown" class="countdown">3</div>
        </div>

        <!-- æœ€çµ‚çµæœç•«é¢ -->
        <div id="finalScreen" class="final-screen hidden">
            <h1>ğŸ‰ éŠæˆ²çµæŸ</h1>

            <div id="finalResult" style="margin: 30px 0;">
                <div id="finalScore" class="score-display"></div>
                <div id="finalRank" class="rank-display"></div>
            </div>

            <div id="finalLeaderboard" style="margin: 30px 0;">
                <h2>ğŸ† æœ€çµ‚æ’è¡Œæ¦œ</h2>
                <div id="finalLeaderboardContainer"></div>
            </div>

            <div id="gameEndButtons" style="margin-top: 30px; display: none;">
                <!-- æŒ‰éˆ•å·²ç§»é™¤ -->
            </div>
        </div>
    </div>

    <script src="/public/js/common.js"></script>
    <script>
        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            currentScreen: 'waiting',
            userId: null,
            questions: [],
            totalQuestions: 0,
            currentQuestion: 0,
            selectedAnswer: null,
            questionStartTime: null,
            timers: [],
            localTimers: [], // å®¢æˆ¶ç«¯è¨ˆæ™‚å™¨
            isJoining: false, // é˜²æ­¢é‡è¤‡åŠ å…¥
            config: {
                questionTimeLimit: 10000 // é è¨­å€¼
            }
        };

        // è¼‰å…¥éŠæˆ²é…ç½®
        async function loadGameConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // ä¿å­˜é…ç½®åˆ°éŠæˆ²ç‹€æ…‹
                gameState.config = config;

                // æ›´æ–°é é¢æ¨™é¡Œ
                document.getElementById('pageTitle').textContent = config.gameName;
                document.title = config.gameName;

                // æ›´æ–°åˆå§‹è¨ˆæ™‚å™¨é¡¯ç¤º
                const timeLimitSeconds = Math.floor(config.questionTimeLimit / 1000);
                document.getElementById('gameTimer').textContent = timeLimitSeconds;

                console.log('éŠæˆ²é…ç½®å·²è¼‰å…¥ï¼Œé¡Œç›®æ™‚é™:', config.questionTimeLimit, 'ms');
            } catch (error) {
                console.log('ç„¡æ³•è¼‰å…¥éŠæˆ²é…ç½®ï¼Œä½¿ç”¨é è¨­å€¼');
            }
        }

        // è¼‰å…¥é…ç½®
        loadGameConfig();

        // WebSocketé€£æ¥
        const ws = new GameWebSocket();

        // DOMå…ƒç´ 
        const screens = {
            waiting: document.getElementById('waitingScreen'),
            startCountdown: document.getElementById('startCountdownScreen'),
            game: document.getElementById('gameScreen'),
            results: document.getElementById('resultsScreen'),
            nextQuestion: document.getElementById('nextQuestionScreen'),
            final: document.getElementById('finalScreen')
        };

        // åˆå§‹åŒ–
        function init() {
            console.log('éŠæˆ²é é¢åˆå§‹åŒ–é–‹å§‹');
            const urlParams = new URLSearchParams(window.location.search);
            const isReconnecting = urlParams.get('reconnect') === 'true';
            const playerName = urlParams.get('name') || sessionStorage.getItem('playerName') || localStorage.getItem('gameUserName');

            console.log('ç©å®¶åç¨±:', playerName);

            if (!playerName) {
                console.log('æ²’æœ‰ç©å®¶åç¨±ï¼Œé‡å®šå‘åˆ°ä¸»é ');
                window.location.href = '/home';
                return;
            }

            document.getElementById('playerWelcome').textContent = `æ­¡è¿, ${playerName}!`;

            // è¨­ç½®WebSocketäº‹ä»¶è™•ç†
            ws.onopen = () => {
                console.log('WebSocketé€£æ¥æˆåŠŸï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ¶ID');
                updateConnectionStatus(true);

                if (gameState.isJoining) {
                    console.log('æ­£åœ¨åŠ å…¥éŠæˆ²ä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚');
                    return;
                }

                gameState.isJoining = true;

                // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ¶IDï¼Œå¦‚æœæœ‰å‰‡å˜—è©¦é‡é€£
                const savedUserId = localStorage.getItem('gameUserId');
                if (savedUserId && (isReconnecting || localStorage.getItem('gameUserName'))) {
                    console.log('ç™¼ç¾ä¿å­˜çš„ç”¨æˆ¶IDï¼Œå˜—è©¦é‡é€£:', savedUserId);
                    ws.send({
                        type: 'reconnect',
                        userId: savedUserId
                    });
                } else {
                    console.log('æ²’æœ‰ä¿å­˜çš„ç”¨æˆ¶IDï¼Œç™¼é€æ–°åŠ å…¥è«‹æ±‚');
                    // æ¸…é™¤èˆŠçš„éŠæˆ²è³‡æ–™ï¼ˆé–‹å§‹æ–°éŠæˆ²ï¼‰
                    localStorage.removeItem('gameUserId');
                    localStorage.removeItem('gameUserName');
                    ws.send({
                        type: 'join',
                        name: playerName
                    });
                }
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
            };

            // è¨»å†Šè¨Šæ¯è™•ç†å™¨
            ws.on('connected', handleConnected);
            ws.on('reconnected', handleReconnected);
            ws.on('users_update', handleUsersUpdate);
            ws.on('game_starting', handleGameStarting);
            ws.on('question_start', handleQuestionStart);
            ws.on('show_results', handleShowResults);
            ws.on('next_question_countdown', handleNextQuestionCountdown);
            ws.on('game_end', handleGameEnd);
            ws.on('error', handleError);

            // é€£æ¥WebSocket
            console.log('æº–å‚™é€£æ¥WebSocket');
            ws.connect();
        }

        // é€£æ¥ç‹€æ…‹æ›´æ–°
        function updateConnectionStatus(connected) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = statusIndicator.nextElementSibling;

            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'å·²é€£æ¥åˆ°éŠæˆ²ä¼ºæœå™¨';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'é€£æ¥å·²æ–·é–‹ï¼Œå˜—è©¦é‡é€£ä¸­...';
            }
        }

        // è™•ç†é€£æ¥æˆåŠŸ
        function handleConnected(message) {
            gameState.userId = message.userId;
            gameState.questions = message.questions;
            gameState.totalQuestions = message.totalQuestions;
            gameState.isJoining = false; // é‡ç½®åŠ å…¥ç‹€æ…‹

            // ä¿å­˜ç”¨æˆ¶IDå’Œåç¨±åˆ°localStorageï¼Œç”¨æ–¼æ–·ç·šé‡é€£
            localStorage.setItem('gameUserId', gameState.userId);
            localStorage.setItem('gameUserName', message.name || gameState.playerName);

            // æ›´æ–°ç©å®¶åˆ†æ•¸é¡¯ç¤º
            updatePlayerScore(0);

            showNotification('æˆåŠŸåŠ å…¥éŠæˆ²ï¼', 'success');
        }

        // è™•ç†é‡é€£æˆåŠŸ
        function handleReconnected(message) {
            console.log('è™•ç†é‡é€£æˆåŠŸ:', message);
            gameState.userId = message.userId;
            gameState.totalQuestions = message.totalQuestions;
            gameState.questions = message.questions; // åŒæ­¥é¡Œç›®æ•¸æ“š
            gameState.isJoining = false; // é‡ç½®åŠ å…¥ç‹€æ…‹

            console.log('åŒæ­¥çš„é¡Œç›®æ•¸æ“š:', gameState.questions);
            console.log('éŠæˆ²ç‹€æ…‹:', message.gameStatus);
            console.log('ç•¶å‰é¡Œç›®:', message.currentQuestion);
            console.log('æ˜¯å¦é¡¯ç¤ºçµæœ:', message.showingResults);

            // ç¢ºä¿ç”¨æˆ¶IDä¿å­˜åœ¨localStorageä¸­
            localStorage.setItem('gameUserId', gameState.userId);

            // æ›´æ–°ç©å®¶åˆ†æ•¸é¡¯ç¤º
            updatePlayerScore(message.score || 0);

            // æ ¹æ“šç•¶å‰éŠæˆ²ç‹€æ…‹åˆ‡æ›ç•«é¢
            if (message.gameStatus === 'playing') {
                if (message.showingResults) {
                    // å¦‚æœåœ¨é¡¯ç¤ºçµæœï¼Œåˆ‡æ›åˆ°çµæœç•«é¢ä¸¦é‡å»ºçµæœå…§å®¹
                    console.log('åˆ‡æ›åˆ°çµæœç•«é¢ä¸¦é‡å»ºçµæœ');
                    switchScreen('results');
                    if (message.resultData) {
                        rebuildResultsScreen(message.resultData, message.currentQuestion);
                    }
                } else {
                    // å¦‚æœåœ¨é€²è¡ŒéŠæˆ²ï¼Œåˆ‡æ›åˆ°éŠæˆ²ç•«é¢ä½†é¡¯ç¤ºé‡é€£ç­‰å¾…ç‹€æ…‹
                    console.log('åˆ‡æ›åˆ°éŠæˆ²ç•«é¢ä¸¦é¡¯ç¤ºé‡é€£ç­‰å¾…');
                    switchScreen('game');
                    if (message.currentQuestion >= 0 && gameState.questions.length > 0) {
                        loadQuestion(message.currentQuestion);
                        // é¡¯ç¤ºé‡é€£ç­‰å¾…ç‹€æ…‹è€Œä¸æ˜¯é‡æ–°é–‹å§‹è¨ˆæ™‚å™¨
                        showReconnectedWaitingState();
                    }
                }
            } else {
                console.log('éŠæˆ²ç‹€æ…‹ä¸æ˜¯playing:', message.gameStatus);
            }

            showNotification('é‡é€£æˆåŠŸï¼', 'success');
        }

        // è™•ç†ç”¨æˆ¶åˆ—è¡¨æ›´æ–°
        function handleUsersUpdate(message) {
            const container = document.getElementById('usersContainer');
            const playerCountElement = document.getElementById('playerCount');
            const moreIndicator = document.getElementById('morePlayersIndicator');

            // æ›´æ–°ç©å®¶ç¸½æ•¸
            playerCountElement.textContent = `(${message.users.length})`;

            container.innerHTML = '';

            // é™åˆ¶é¡¯ç¤ºçš„ç©å®¶æ•¸é‡ï¼Œé¿å…åˆ—è¡¨éé•·
            const maxDisplayUsers = 10;
            const displayUsers = message.users.slice(0, maxDisplayUsers);
            const hasMore = message.users.length > maxDisplayUsers;

            // ç¢ºä¿ç•¶å‰ç”¨æˆ¶å§‹çµ‚é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­
            let currentUserShown = false;
            const currentUserIndex = message.users.findIndex(user => user.id === gameState.userId);

            if (currentUserIndex >= maxDisplayUsers) {
                // å¦‚æœç•¶å‰ç”¨æˆ¶ä¸åœ¨å‰10åä¸­ï¼Œæ›¿æ›æœ€å¾Œä¸€å€‹ä½ç½®
                displayUsers[maxDisplayUsers - 1] = message.users[currentUserIndex];
                currentUserShown = true;
            }

            displayUsers.forEach((user, index) => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.connected ? '' : 'offline'}`;

                const isCurrentUser = user.id === gameState.userId;
                const rankDisplay = currentUserIndex >= 0 && currentUserIndex >= maxDisplayUsers && isCurrentUser
                    ? `#${currentUserIndex + 1}`
                    : `#${index + 1}`;

                userElement.innerHTML = `
                    <div class="user-info">
                        <span class="status-indicator ${user.connected ? 'online' : 'offline'}"></span>
                        <span class="user-rank">${rankDisplay}</span>
                        <span class="user-name">${user.name} ${isCurrentUser ? '(æ‚¨)' : ''}</span>
                    </div>
                    <div class="user-score">
                        ${user.score} åˆ†
                    </div>
                `;

                if (isCurrentUser) {
                    userElement.classList.add('current-user');
                }

                container.appendChild(userElement);
            });

            // é¡¯ç¤ºæˆ–éš±è—"æ›´å¤šç©å®¶"æŒ‡ç¤ºå™¨
            if (hasMore) {
                moreIndicator.classList.remove('hidden');
                moreIndicator.textContent = `é‚„æœ‰ ${message.users.length - maxDisplayUsers} ä½ç©å®¶...`;
            } else {
                moreIndicator.classList.add('hidden');
            }
        }

        // è™•ç†éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚ï¼ˆå®¢æˆ¶ç«¯å¯¦ç¾ï¼‰
        function handleGameStarting(message) {
            switchScreen('startCountdown');

            const countdownElement = document.getElementById('startCountdown');
            // ä½¿ç”¨å®¢æˆ¶ç«¯å€’è¨ˆæ™‚ï¼Œ3ç§’å›ºå®š
            startClientCountdown(countdownElement, 3, () => {
                // å€’è¨ˆæ™‚çµæŸå¾Œç­‰å¾…ç¬¬ä¸€é¡Œ
                console.log('éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚å®Œæˆï¼Œç­‰å¾…ç¬¬ä¸€é¡Œ');
            });
        }

        // è™•ç†é¡Œç›®é–‹å§‹
        function handleQuestionStart(message) {
            console.log('è™•ç†é¡Œç›®é–‹å§‹:', message);
            gameState.currentQuestion = message.questionIndex;
            gameState.questionStartTime = Date.now(); // ä½¿ç”¨æœ¬åœ°æ™‚é–“
            gameState.selectedAnswer = null;

            console.log('åˆ‡æ›åˆ°éŠæˆ²ç•«é¢');
            switchScreen('game');

            // å¦‚æœæ¶ˆæ¯ä¸­åŒ…å«é¡Œç›®æ•¸æ“šï¼Œç›´æ¥ä½¿ç”¨å®ƒ
            if (message.question) {
                console.log('ä½¿ç”¨æ¶ˆæ¯ä¸­çš„é¡Œç›®æ•¸æ“š:', message.question);
                loadQuestionFromData(message.questionIndex, message.question);
            } else {
                // å¦å‰‡å¾gameState.questionsä¸­è¼‰å…¥
                console.log('å¾gameStateè¼‰å…¥é¡Œç›®:', message.questionIndex);
                loadQuestion(message.questionIndex);
            }

            // ä½¿ç”¨å®¢æˆ¶ç«¯è¨ˆæ™‚å™¨ï¼Œå¾æ¶ˆæ¯ã€é¡Œç›®æ•¸æ“šæˆ–é…ç½®ä¸­ç²å–æ™‚é–“é™åˆ¶ï¼ˆæ¯«ç§’è½‰ç§’ï¼‰
            const timeLimit = message.question?.timeLimit || gameState.questions[message.questionIndex]?.timeLimit || gameState.config.questionTimeLimit || 10000;
            const timeLimitSeconds = Math.floor(timeLimit / 1000);
            console.log('é–‹å§‹è¨ˆæ™‚å™¨ï¼Œæ™‚é–“é™åˆ¶:', timeLimitSeconds, 'ç§’');
            startQuestionTimer(timeLimitSeconds);
        }

        // è¼‰å…¥é¡Œç›®
        function loadQuestion(questionIndex) {
            console.log('è¼‰å…¥é¡Œç›®å‡½æ•¸è¢«èª¿ç”¨:', questionIndex);
            console.log('ç•¶å‰é¡Œç›®æ•¸æ“š:', gameState.questions);
            console.log('ç¸½é¡Œç›®æ•¸:', gameState.totalQuestions);

            if (!gameState.questions || gameState.questions.length === 0) {
                console.error('æ²’æœ‰é¡Œç›®æ•¸æ“š!');
                return;
            }

            if (questionIndex >= gameState.questions.length) {
                console.error('é¡Œç›®ç´¢å¼•è¶…å‡ºç¯„åœ:', questionIndex, 'ç¸½é¡Œç›®æ•¸:', gameState.questions.length);
                return;
            }

            const question = gameState.questions[questionIndex];
            console.log('è¼‰å…¥çš„é¡Œç›®:', question);

            document.getElementById('questionCounter').textContent =
                `ç¬¬ ${questionIndex + 1} é¡Œ / å…± ${gameState.totalQuestions} é¡Œ`;

            document.getElementById('questionText').textContent = question.question;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(index));
                optionsContainer.appendChild(optionElement);
            });

            document.getElementById('answerIndicator').textContent = '';
            console.log('é¡Œç›®è¼‰å…¥å®Œæˆ');
        }

        // å¾æ¶ˆæ¯æ•¸æ“šè¼‰å…¥é¡Œç›®
        function loadQuestionFromData(questionIndex, questionData) {
            console.log('å¾æ¶ˆæ¯æ•¸æ“šè¼‰å…¥é¡Œç›®:', questionIndex, questionData);

            document.getElementById('questionCounter').textContent =
                `ç¬¬ ${questionIndex + 1} é¡Œ / å…± ${gameState.totalQuestions} é¡Œ`;

            document.getElementById('questionText').textContent = questionData.question;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            questionData.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(index));
                optionsContainer.appendChild(optionElement);
            });

            document.getElementById('answerIndicator').textContent = '';
            console.log('å¾æ¶ˆæ¯æ•¸æ“šè¼‰å…¥é¡Œç›®å®Œæˆ');
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(answerIndex) {
            if (gameState.selectedAnswer !== null) return;

            gameState.selectedAnswer = answerIndex;
            const timeSpent = Date.now() - gameState.questionStartTime;

            // è¦–è¦ºåé¥‹
            const options = document.querySelectorAll('.option');
            options[answerIndex].classList.add('selected');
            options.forEach(option => option.style.pointerEvents = 'none');

            document.getElementById('answerIndicator').textContent = 'ç­”æ¡ˆå·²æäº¤ï¼Œç­‰å¾…çµæœ...';

            // ç™¼é€ç­”æ¡ˆåˆ°ä¼ºæœå™¨
            ws.send({
                type: 'answer',
                questionIndex: gameState.currentQuestion,
                answer: answerIndex,
                timeSpent: timeSpent
            });
        }

        // å®¢æˆ¶ç«¯é€šç”¨å€’è¨ˆæ™‚å‡½æ•¸
        function startClientCountdown(element, seconds, onComplete) {
            element.textContent = seconds;

            const timer = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(timer);
                    onComplete && onComplete();
                } else {
                    element.textContent = seconds;
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // å®¢æˆ¶ç«¯é¡Œç›®è¨ˆæ™‚å™¨
        function startQuestionTimer(duration) {
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = duration;
            timerElement.style.color = '';
            timerElement.style.animation = '';

            let remaining = duration;

            const timer = setInterval(() => {
                remaining--;
                timerElement.textContent = remaining;

                // æ™‚é–“å¿«ç”¨å®Œæ™‚çš„è¦–è¦ºæ•ˆæœ
                if (remaining <= 3) {
                    timerElement.style.color = '#dc3545';
                    timerElement.style.animation = 'pulse 0.5s infinite';
                }

                if (remaining <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = 'æ™‚é–“åˆ°!';
                    timerElement.style.color = '#dc3545';

                    // å¦‚æœé‚„æ²’é¸æ“‡ï¼Œè‡ªå‹•æäº¤æœªä½œç­”ä¸¦ç¦ç”¨é¸é …
                    if (gameState.selectedAnswer === null) {
                        document.getElementById('answerIndicator').textContent = 'æ™‚é–“åˆ°ï¼ç­‰å¾…çµæœ...';
                        const options = document.querySelectorAll('.option');
                        options.forEach(option => option.style.pointerEvents = 'none');

                            // ç™¼é€è¶…æ™‚ä¿¡è™Ÿåˆ°ä¼ºæœå™¨
                        ws.send({
                            type: 'timeout',
                            questionIndex: gameState.currentQuestion
                        });
                    }
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // è™•ç†çµæœé¡¯ç¤º
        function handleShowResults(message) {
            clearAllTimers();
            switchScreen('results');

            const question = gameState.questions[gameState.currentQuestion];

            // æ›´æ–°å³ä¸Šè§’çš„åˆ†æ•¸é¡¯ç¤º
            updatePlayerScore(message.score);

            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            document.getElementById('correctAnswerDisplay').innerHTML =
                `<div style="color: #28a745; font-weight: bold; font-size: 1.2em;">
                    æ­£ç¢ºç­”æ¡ˆ: ${question.options[message.correctAnswer]}
                </div>`;

            // é¡¯ç¤ºç”¨æˆ¶ç­”æ¡ˆ
            if (message.userAnswer !== null) {
                const isCorrect = message.userAnswer === message.correctAnswer;
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        æ‚¨çš„ç­”æ¡ˆ: ${question.options[message.userAnswer]} ${isCorrect ? 'âœ“' : 'âœ—'}
                    </div>`;
            } else {
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: #999;">æ‚¨æœªä½œç­”æˆ–é‡é€£éŒ¯éæ­¤é¡Œ</div>`;
            }

            // é¡¯ç¤ºæœ¬è¼ªç²å¾—çš„åˆ†æ•¸
            const scoreGainedElement = document.getElementById('scoreGained');
            if (message.scoreGained > 0) {
                scoreGainedElement.innerHTML = `ğŸ‰ æœ¬è¼ªç²å¾—: ${message.scoreGained} åˆ†`;
                scoreGainedElement.style.color = '#28a745';
            } else {
                scoreGainedElement.innerHTML = `æœ¬è¼ªç²å¾—: ${message.scoreGained} åˆ†`;
                scoreGainedElement.style.color = '#999';
            }

            // é¡¯ç¤ºåˆ†æ•¸å’Œæ’å
            document.getElementById('currentScore').textContent = `ç¸½åˆ†æ•¸: ${message.score}`;
            document.getElementById('currentRank').textContent = `æ’å: ç¬¬ ${message.rank} å`;

            if (message.gap > 0) {
                document.getElementById('rankGap').textContent =
                    `è·é›¢å‰ä¸€åé‚„å·® ${message.gap} åˆ†`;
            } else {
                document.getElementById('rankGap').textContent = '';
            }

            // é¡¯ç¤ºæ’è¡Œæ¦œ
            displayLeaderboard(message.leaderboard);
        }

        // é¡¯ç¤ºæ’è¡Œæ¦œ
        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '';

            leaderboard.slice(0, 5).forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `leaderboard-item ${item.rank <= 3 ? 'top3' : ''}`;

                const rankEmoji = item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : item.rank === 3 ? 'ğŸ¥‰' : '';

                itemElement.innerHTML = `
                    <div>
                        ${rankEmoji} ${item.rank}. ${item.name}
                        ${item.id === gameState.userId ? ' (æ‚¨)' : ''}
                    </div>
                    <div style="font-weight: bold;">
                        ${item.score} åˆ†
                    </div>
                `;

                container.appendChild(itemElement);
            });
        }

        // è™•ç†ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚ï¼ˆå®¢æˆ¶ç«¯å¯¦ç¾ï¼‰
        function handleNextQuestionCountdown(message) {
            switchScreen('nextQuestion');

            const countdownElement = document.getElementById('nextCountdown');
            // ä½¿ç”¨å®¢æˆ¶ç«¯å€’è¨ˆæ™‚ï¼Œ3ç§’å›ºå®š
            startClientCountdown(countdownElement, 3, () => {
                // å€’è¨ˆæ™‚çµæŸå¾Œç­‰å¾…ä¸‹ä¸€é¡Œ
                console.log('ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚å®Œæˆ');
            });
        }

        // è™•ç†éŠæˆ²çµæŸ
        function handleGameEnd(message) {
            switchScreen('final');

            // æ¸…é™¤éŠæˆ²è³‡æ–™ï¼Œå› ç‚ºéŠæˆ²å·²çµæŸ
            localStorage.removeItem('gameUserId');
            localStorage.removeItem('gameUserName');

            const config = message.config || {};

            // è¨ˆç®—ç©å®¶çš„åˆ†æ•¸å’Œæ’åï¼ˆå¾allPlayersä¸­æŸ¥æ‰¾ï¼‰
            let finalScore = message.finalScore;
            let finalRank = message.finalRank;

            if (message.allPlayers && message.allPlayers.length > 0 && gameState.userId) {
                const playerIndex = message.allPlayers.findIndex(p => p.id === gameState.userId);
                if (playerIndex !== -1) {
                    finalScore = message.allPlayers[playerIndex].score;
                    finalRank = playerIndex + 1;
                }
            }

            // æ ¹æ“šé…ç½®æ±ºå®šæ˜¯å¦é¡¯ç¤ºåˆ†æ•¸å’Œæ’å
            if (config.showLeaderboard !== false) {
                document.getElementById('finalScore').textContent = `æœ€çµ‚åˆ†æ•¸: ${finalScore || 0}`;
                document.getElementById('finalRank').textContent = `æœ€çµ‚æ’å: ç¬¬ ${finalRank || '-'} å`;
            } else {
                document.getElementById('finalScore').textContent = `æ‚¨çš„åˆ†æ•¸: ${finalScore || 0}`;
                document.getElementById('finalRank').style.display = 'none';
            }

            // é¡¯ç¤ºå®Œæ•´æ’è¡Œæ¦œ
            const container = document.getElementById('finalLeaderboardContainer');
            container.innerHTML = '';

            // ç¸½æ˜¯é¡¯ç¤ºå®Œæ•´æ’è¡Œæ¦œï¼ˆå¦‚æœæœ‰ç©å®¶æ•¸æ“šï¼‰
            if (message.allPlayers && message.allPlayers.length > 0) {
                message.allPlayers.forEach((player, index) => {
                    const rank = index + 1;
                    let emoji = '';
                    if (rank === 1) emoji = 'ğŸ¥‡';
                    else if (rank === 2) emoji = 'ğŸ¥ˆ';
                    else if (rank === 3) emoji = 'ğŸ¥‰';

                    const itemElement = document.createElement('div');
                    itemElement.className = `leaderboard-item ${rank <= 3 ? 'top3' : ''}`;
                    itemElement.innerHTML = `
                        <div style="font-size: ${rank <= 3 ? '1.2em' : '1em'};">
                            ${emoji} ${rank}. ${player.name}
                            ${player.id === gameState.userId ? ' (æ‚¨)' : ''}
                        </div>
                        <div style="font-size: ${rank <= 3 ? '1.2em' : '1em'}; font-weight: bold;">
                            ${player.score} åˆ†
                        </div>
                    `;
                    container.appendChild(itemElement);
                });

                // å¦‚æœé…ç½®è¦æ±‚ä¸é¡¯ç¤ºæ’è¡Œæ¦œï¼Œåœ¨æ’è¡Œæ¦œå¾Œé¢é¡¯ç¤ºè‡ªè¨‚çµå°¾è¨Šæ¯
                if (config.showLeaderboard === false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = 'text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px; margin: 20px 0;';
                    messageDiv.innerHTML = `
                        <h2 style="color: #667eea; margin-bottom: 15px;">${config.endGameMessage || 'æ„Ÿè¬åƒèˆ‡æœ¬æ¬¡çŸ¥è­˜ç«¶è³½ï¼'}</h2>
                        <p style="color: #666; font-size: 1.1em;">${config.endGameSubMessage || 'å¸Œæœ›ä½ åœ¨éŠæˆ²ä¸­å­¸åˆ°äº†æ–°çŸ¥è­˜ã€‚'}</p>
                    `;
                    container.appendChild(messageDiv);
                }
            } else {
                // å¦‚æœæ²’æœ‰ç©å®¶æ•¸æ“šï¼Œåªé¡¯ç¤ºè‡ªè¨‚çµå°¾è¨Šæ¯
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px; margin: 20px 0;';
                messageDiv.innerHTML = `
                    <h2 style="color: #667eea; margin-bottom: 15px;">${config.endGameMessage || 'æ„Ÿè¬åƒèˆ‡æœ¬æ¬¡çŸ¥è­˜ç«¶è³½ï¼'}</h2>
                    <p style="color: #666; font-size: 1.1em;">${config.endGameSubMessage || 'å¸Œæœ›ä½ åœ¨éŠæˆ²ä¸­å­¸åˆ°äº†æ–°çŸ¥è­˜ã€‚'}</p>
                `;
                container.appendChild(messageDiv);
            }

            // æŒ‰éˆ•å·²åœ¨HTMLä¸­è¨­ç‚ºéš±è—ï¼Œä¸å†é¡¯ç¤º
            const buttonsContainer = document.getElementById('gameEndButtons');
            buttonsContainer.style.display = 'none';
        }

        // è™•ç†éŒ¯èª¤è¨Šæ¯
        function handleError(message) {
            console.log('éŠæˆ²é é¢æ”¶åˆ°éŒ¯èª¤:', message.message);

            // å¦‚æœæ˜¯ç”¨æˆ¶ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼Œæ¸…é™¤ä¿å­˜çš„ç”¨æˆ¶IDä¸¦é‡æ–°ä»¥æ–°ç”¨æˆ¶èº«ä»½åŠ å…¥
            if (message.message === 'ç”¨æˆ¶ä¸å­˜åœ¨' && !gameState.isJoining) {
                console.log('ç”¨æˆ¶ä¸å­˜åœ¨ï¼Œæ¸…é™¤ä¿å­˜çš„IDä¸¦é‡æ–°åŠ å…¥');
                localStorage.removeItem('gameUserId');
                localStorage.removeItem('gameUserName');
                gameState.isJoining = true;

                // é‡æ–°ç™¼é€åŠ å…¥è«‹æ±‚
                const urlParams = new URLSearchParams(window.location.search);
                const playerName = urlParams.get('name') || sessionStorage.getItem('playerName');

                if (playerName) {
                    setTimeout(() => {
                        ws.send({
                            type: 'join',
                            name: playerName
                        });
                    }, 100); // ç¨å¾®å»¶é²é¿å…è¡çª
                }
            } else {
                // å…¶ä»–éŒ¯èª¤é¡¯ç¤ºé€šçŸ¥
                showNotification(message.message, 'error');
                gameState.isJoining = false; // é‡ç½®ç‹€æ…‹
            }
        }

        // åˆ‡æ›ç•«é¢
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
            });

            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                gameState.currentScreen = screenName;
            }
        }

        // æ›´æ–°ç©å®¶åˆ†æ•¸é¡¯ç¤º
        function updatePlayerScore(score) {
            const playerScoreElement = document.getElementById('playerScore');
            if (playerScoreElement) {
                playerScoreElement.textContent = `åˆ†æ•¸: ${score}`;
            }
        }

        // é¡¯ç¤ºé‡é€£å¾Œçš„ç­‰å¾…ç‹€æ…‹
        function showReconnectedWaitingState() {
            console.log('é¡¯ç¤ºé‡é€£ç­‰å¾…ç‹€æ…‹');

            // åœæ­¢è¨ˆæ™‚å™¨é¡¯ç¤º
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = 'é‡é€£ä¸­';
            timerElement.style.color = '#6c757d';
            timerElement.style.animation = '';

            // ç¦ç”¨é¸é …
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                option.style.opacity = '0.6';
            });

            // é¡¯ç¤ºç­‰å¾…æç¤º
            document.getElementById('answerIndicator').innerHTML =
                '<div style="color: #6c757d; font-style: italic;">â³ æ–·ç·šé‡é€£ï¼Œç­‰å¾…æ­¤é¡ŒçµæŸ...</div>';
        }

        // é‡å»ºçµæœç•«é¢
        function rebuildResultsScreen(resultData, questionIndex) {
            console.log('é‡å»ºçµæœç•«é¢:', resultData, questionIndex);

            const question = gameState.questions[questionIndex];
            if (!question) {
                console.error('æ‰¾ä¸åˆ°é¡Œç›®æ•¸æ“š:', questionIndex);
                return;
            }

            // å¾é‡é€£æ¶ˆæ¯ä¸­ç²å–ç•¶å‰åˆ†æ•¸
            const currentScore = gameState.userId && Array.from(gameState.users?.values() || [])
                .find(u => u.id === gameState.userId)?.score || 0;

            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            document.getElementById('correctAnswerDisplay').innerHTML =
                `<div style="color: #28a745; font-weight: bold; font-size: 1.2em;">
                    æ­£ç¢ºç­”æ¡ˆ: ${question.options[resultData.correctAnswer]}
                </div>`;

            // é¡¯ç¤ºç”¨æˆ¶ç­”æ¡ˆ
            if (resultData.userAnswer !== null) {
                const isCorrect = resultData.userAnswer === resultData.correctAnswer;
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        æ‚¨çš„ç­”æ¡ˆ: ${question.options[resultData.userAnswer]} ${isCorrect ? 'âœ“' : 'âœ—'}
                    </div>`;
            } else {
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: #999;">æ‚¨æœªä½œç­”æˆ–é‡é€£éŒ¯éæ­¤é¡Œ</div>`;
            }

            // é¡¯ç¤ºåˆ†æ•¸å’Œæ’å
            document.getElementById('currentScore').textContent = `åˆ†æ•¸: ${currentScore}`;
            document.getElementById('currentRank').textContent = `æ’å: ç¬¬ ${resultData.rank} å`;

            if (resultData.gap > 0) {
                document.getElementById('rankGap').textContent =
                    `è·é›¢å‰ä¸€åé‚„å·® ${resultData.gap} åˆ†`;
            } else {
                document.getElementById('rankGap').textContent = '';
            }

            // é¡¯ç¤ºæ’è¡Œæ¦œ
            displayLeaderboard(resultData.leaderboard);

            console.log('çµæœç•«é¢é‡å»ºå®Œæˆ');
        }

        // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
        function clearAllTimers() {
            gameState.timers.forEach(timer => clearInterval(timer));
            gameState.timers = [];
            gameState.localTimers.forEach(timer => clearInterval(timer));
            gameState.localTimers = [];
        }

        // å†ç©ä¸€æ¬¡
        function playAgain() {
            localStorage.removeItem('gameUserId');
            localStorage.removeItem('gameUserName');
            window.location.reload();
        }

        // å›åˆ°ä¸»é 
        function goHome() {
            localStorage.removeItem('gameUserId');
            localStorage.removeItem('gameUserName');
            ws.close();
            window.location.href = '/home';
        }

        // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
        window.addEventListener('beforeunload', () => {
            ws.close();
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>