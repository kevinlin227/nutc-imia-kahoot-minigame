<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot 遊戲</title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
    <div class="container">
        <!-- 等待畫面 -->
        <div id="waitingScreen" class="waiting-screen">
            <h1>🎮 等待遊戲開始</h1>
            <p id="playerWelcome" style="font-size: 1.2em; color: #667eea; margin-bottom: 20px;"></p>

            <div id="connectionStatus" style="margin: 20px 0;">
                <div class="status-indicator online"></div>
                <span>已連接到遊戲伺服器</span>
            </div>

            <div id="usersList" class="users-list">
                <h3>參與者列表 <span id="playerCount" class="player-count">(0)</span></h3>
                <div id="usersContainer" class="users-container"></div>
                <div id="morePlayersIndicator" class="more-players hidden">
                    還有更多玩家...
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                <p style="color: #666;">等待管理員開始遊戲...</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">
                    題目已預載完成，斷線後可自動重連
                </p>
            </div>
        </div>

        <!-- 遊戲開始倒計時 -->
        <div id="startCountdownScreen" class="hidden">
            <h1>🚀 遊戲即將開始</h1>
            <div id="startCountdown" class="countdown">3</div>
            <p style="color: #666;">準備好了嗎？</p>
        </div>

        <!-- 遊戲進行畫面 -->
        <div id="gameScreen" class="game-screen hidden">
            <div id="gameHeader" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="questionCounter" style="color: #667eea; font-weight: bold;"></div>
                    <div id="playerScore" class="score-display">分數: 0</div>
                </div>
                <div id="gameTimer" class="timer">10</div>
            </div>

            <div id="questionContainer" class="question-container">
                <div id="questionText" class="question"></div>
                <div id="optionsContainer" class="options"></div>
            </div>

            <div id="answerStatus" style="margin-top: 20px; color: #666;">
                <span id="answerIndicator"></span>
            </div>
        </div>

        <!-- 題目結果畫面 -->
        <div id="resultsScreen" class="results-screen hidden">
            <h2>📊 題目結果</h2>

            <div id="answerResult" style="margin: 30px 0;">
                <div id="correctAnswerDisplay" style="margin-bottom: 15px;"></div>
                <div id="userAnswerDisplay"></div>
            </div>

            <div id="scoreUpdate" style="margin: 20px 0;">
                <div id="currentScore" class="score-display"></div>
                <div id="currentRank" class="rank-display"></div>
                <div id="rankGap" style="color: #999; font-size: 14px;"></div>
            </div>

            <div id="miniLeaderboard" class="leaderboard">
                <h3>當前排行榜</h3>
                <div id="leaderboardContainer"></div>
            </div>

            <div style="margin-top: 20px; color: #666;">
                等待進入下一題...
            </div>
        </div>

        <!-- 下一題倒計時 -->
        <div id="nextQuestionScreen" class="hidden">
            <h2>➡️ 下一題準備中</h2>
            <div id="nextCountdown" class="countdown">3</div>
        </div>

        <!-- 最終結果畫面 -->
        <div id="finalScreen" class="final-screen hidden">
            <h1>🎉 遊戲結束</h1>

            <div id="finalResult" style="margin: 30px 0;">
                <div id="finalScore" class="score-display"></div>
                <div id="finalRank" class="rank-display"></div>
            </div>

            <div id="topThree" style="margin: 30px 0;">
                <h2>🏆 前三名</h2>
                <div id="topThreeContainer"></div>
            </div>

            <div style="margin-top: 30px;">
                <button onclick="playAgain()">🔄 再玩一次</button>
                <button onclick="goHome()" style="background: #6c757d;">🏠 回到主頁</button>
            </div>
        </div>
    </div>

    <script src="/public/js/common.js"></script>
    <script>
        // 遊戲狀態
        const gameState = {
            currentScreen: 'waiting',
            userId: null,
            questions: [],
            totalQuestions: 0,
            currentQuestion: 0,
            selectedAnswer: null,
            questionStartTime: null,
            timers: [],
            localTimers: [] // 客戶端計時器
        };

        // WebSocket連接
        const ws = new GameWebSocket();

        // DOM元素
        const screens = {
            waiting: document.getElementById('waitingScreen'),
            startCountdown: document.getElementById('startCountdownScreen'),
            game: document.getElementById('gameScreen'),
            results: document.getElementById('resultsScreen'),
            nextQuestion: document.getElementById('nextQuestionScreen'),
            final: document.getElementById('finalScreen')
        };

        // 初始化
        function init() {
            console.log('遊戲頁面初始化開始');
            const urlParams = new URLSearchParams(window.location.search);
            const playerName = urlParams.get('name') || sessionStorage.getItem('playerName');

            console.log('玩家名稱:', playerName);

            if (!playerName) {
                console.log('沒有玩家名稱，重定向到主頁');
                window.location.href = '/home';
                return;
            }

            document.getElementById('playerWelcome').textContent = `歡迎, ${playerName}!`;

            // 設置WebSocket事件處理
            ws.onopen = () => {
                console.log('WebSocket連接成功，發送加入請求');
                updateConnectionStatus(true);
                ws.send({
                    type: 'join',
                    name: playerName
                });
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
            };

            // 註冊訊息處理器
            ws.on('connected', handleConnected);
            ws.on('reconnected', handleReconnected);
            ws.on('users_update', handleUsersUpdate);
            ws.on('game_starting', handleGameStarting);
            ws.on('question_start', handleQuestionStart);
            ws.on('show_results', handleShowResults);
            ws.on('next_question_countdown', handleNextQuestionCountdown);
            ws.on('game_end', handleGameEnd);

            // 連接WebSocket
            console.log('準備連接WebSocket');
            ws.connect();
        }

        // 連接狀態更新
        function updateConnectionStatus(connected) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = statusIndicator.nextElementSibling;

            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = '已連接到遊戲伺服器';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = '連接已斷開，嘗試重連中...';
            }
        }

        // 處理連接成功
        function handleConnected(message) {
            gameState.userId = message.userId;
            gameState.questions = message.questions;
            gameState.totalQuestions = message.totalQuestions;

            showNotification('成功加入遊戲！', 'success');
        }

        // 處理重連成功
        function handleReconnected(message) {
            gameState.userId = message.userId;
            gameState.totalQuestions = message.totalQuestions;

            // 根據當前遊戲狀態切換畫面
            if (message.gameStatus === 'playing') {
                if (message.showingResults) {
                    // 如果在顯示結果，切換到結果畫面
                    switchScreen('results');
                } else {
                    // 如果在進行遊戲，切換到遊戲畫面
                    switchScreen('game');
                    loadQuestion(message.currentQuestion);
                }
            }

            showNotification('重連成功！', 'success');
        }

        // 處理用戶列表更新
        function handleUsersUpdate(message) {
            const container = document.getElementById('usersContainer');
            const playerCountElement = document.getElementById('playerCount');
            const moreIndicator = document.getElementById('morePlayersIndicator');

            // 更新玩家總數
            playerCountElement.textContent = `(${message.users.length})`;

            container.innerHTML = '';

            // 限制顯示的玩家數量，避免列表過長
            const maxDisplayUsers = 10;
            const displayUsers = message.users.slice(0, maxDisplayUsers);
            const hasMore = message.users.length > maxDisplayUsers;

            // 確保當前用戶始終顯示在列表中
            let currentUserShown = false;
            const currentUserIndex = message.users.findIndex(user => user.id === gameState.userId);

            if (currentUserIndex >= maxDisplayUsers) {
                // 如果當前用戶不在前10名中，替換最後一個位置
                displayUsers[maxDisplayUsers - 1] = message.users[currentUserIndex];
                currentUserShown = true;
            }

            displayUsers.forEach((user, index) => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.connected ? '' : 'offline'}`;

                const isCurrentUser = user.id === gameState.userId;
                const rankDisplay = currentUserIndex >= 0 && currentUserIndex >= maxDisplayUsers && isCurrentUser
                    ? `#${currentUserIndex + 1}`
                    : `#${index + 1}`;

                userElement.innerHTML = `
                    <div class="user-info">
                        <span class="status-indicator ${user.connected ? 'online' : 'offline'}"></span>
                        <span class="user-rank">${rankDisplay}</span>
                        <span class="user-name">${user.name} ${isCurrentUser ? '(您)' : ''}</span>
                    </div>
                    <div class="user-score">
                        ${user.score} 分
                    </div>
                `;

                if (isCurrentUser) {
                    userElement.classList.add('current-user');
                }

                container.appendChild(userElement);
            });

            // 顯示或隱藏"更多玩家"指示器
            if (hasMore) {
                moreIndicator.classList.remove('hidden');
                moreIndicator.textContent = `還有 ${message.users.length - maxDisplayUsers} 位玩家...`;
            } else {
                moreIndicator.classList.add('hidden');
            }
        }

        // 處理遊戲開始倒計時（客戶端實現）
        function handleGameStarting(message) {
            switchScreen('startCountdown');

            const countdownElement = document.getElementById('startCountdown');
            // 使用客戶端倒計時，3秒固定
            startClientCountdown(countdownElement, 3, () => {
                // 倒計時結束後等待第一題
                console.log('遊戲開始倒計時完成，等待第一題');
            });
        }

        // 處理題目開始
        function handleQuestionStart(message) {
            gameState.currentQuestion = message.questionIndex;
            gameState.questionStartTime = Date.now(); // 使用本地時間
            gameState.selectedAnswer = null;

            switchScreen('game');
            loadQuestion(message.questionIndex);
            // 使用客戶端10秒計時器
            startQuestionTimer(10);
        }

        // 載入題目
        function loadQuestion(questionIndex) {
            const question = gameState.questions[questionIndex];

            document.getElementById('questionCounter').textContent =
                `第 ${questionIndex + 1} 題 / 共 ${gameState.totalQuestions} 題`;

            document.getElementById('questionText').textContent = question.question;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(index));
                optionsContainer.appendChild(optionElement);
            });

            document.getElementById('answerIndicator').textContent = '';
        }

        // 選擇答案
        function selectAnswer(answerIndex) {
            if (gameState.selectedAnswer !== null) return;

            gameState.selectedAnswer = answerIndex;
            const timeSpent = Date.now() - gameState.questionStartTime;

            // 視覺反饋
            const options = document.querySelectorAll('.option');
            options[answerIndex].classList.add('selected');
            options.forEach(option => option.style.pointerEvents = 'none');

            document.getElementById('answerIndicator').textContent = '答案已提交，等待結果...';

            // 發送答案到伺服器
            ws.send({
                type: 'answer',
                questionIndex: gameState.currentQuestion,
                answer: answerIndex,
                timeSpent: timeSpent
            });
        }

        // 客戶端通用倒計時函數
        function startClientCountdown(element, seconds, onComplete) {
            element.textContent = seconds;

            const timer = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(timer);
                    onComplete && onComplete();
                } else {
                    element.textContent = seconds;
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // 客戶端題目計時器
        function startQuestionTimer(duration) {
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = duration;
            timerElement.style.color = '';
            timerElement.style.animation = '';

            let remaining = duration;

            const timer = setInterval(() => {
                remaining--;
                timerElement.textContent = remaining;

                // 時間快用完時的視覺效果
                if (remaining <= 3) {
                    timerElement.style.color = '#dc3545';
                    timerElement.style.animation = 'pulse 0.5s infinite';
                }

                if (remaining <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = '時間到!';
                    timerElement.style.color = '#dc3545';

                    // 如果還沒選擇，自動提交未作答並禁用選項
                    if (gameState.selectedAnswer === null) {
                        document.getElementById('answerIndicator').textContent = '時間到！等待結果...';
                        const options = document.querySelectorAll('.option');
                        options.forEach(option => option.style.pointerEvents = 'none');

                            // 發送超時信號到伺服器
                        ws.send({
                            type: 'timeout',
                            questionIndex: gameState.currentQuestion
                        });
                    }
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // 處理結果顯示
        function handleShowResults(message) {
            clearAllTimers();
            switchScreen('results');

            const question = gameState.questions[gameState.currentQuestion];

            // 顯示正確答案
            document.getElementById('correctAnswerDisplay').innerHTML =
                `<div style="color: #28a745; font-weight: bold; font-size: 1.2em;">
                    正確答案: ${question.options[message.correctAnswer]}
                </div>`;

            // 顯示用戶答案
            if (message.userAnswer !== null) {
                const isCorrect = message.userAnswer === message.correctAnswer;
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        您的答案: ${question.options[message.userAnswer]} ${isCorrect ? '✓' : '✗'}
                    </div>`;
            } else {
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: #999;">您未作答或重連錯過此題</div>`;
            }

            // 顯示分數和排名
            document.getElementById('currentScore').textContent = `分數: ${message.score}`;
            document.getElementById('currentRank').textContent = `排名: 第 ${message.rank} 名`;

            if (message.gap > 0) {
                document.getElementById('rankGap').textContent =
                    `距離前一名還差 ${message.gap} 分`;
            } else {
                document.getElementById('rankGap').textContent = '';
            }

            // 顯示排行榜
            displayLeaderboard(message.leaderboard);
        }

        // 顯示排行榜
        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '';

            leaderboard.slice(0, 5).forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `leaderboard-item ${item.rank <= 3 ? 'top3' : ''}`;

                const rankEmoji = item.rank === 1 ? '🥇' : item.rank === 2 ? '🥈' : item.rank === 3 ? '🥉' : '';

                itemElement.innerHTML = `
                    <div>
                        ${rankEmoji} ${item.rank}. ${item.name}
                        ${item.id === gameState.userId ? ' (您)' : ''}
                    </div>
                    <div style="font-weight: bold;">
                        ${item.score} 分
                    </div>
                `;

                container.appendChild(itemElement);
            });
        }

        // 處理下一題倒計時（客戶端實現）
        function handleNextQuestionCountdown(message) {
            switchScreen('nextQuestion');

            const countdownElement = document.getElementById('nextCountdown');
            // 使用客戶端倒計時，3秒固定
            startClientCountdown(countdownElement, 3, () => {
                // 倒計時結束後等待下一題
                console.log('下一題倒計時完成');
            });
        }

        // 處理遊戲結束
        function handleGameEnd(message) {
            switchScreen('final');

            document.getElementById('finalScore').textContent = `最終分數: ${message.finalScore}`;
            document.getElementById('finalRank').textContent = `最終排名: 第 ${message.finalRank} 名`;

            // 顯示前三名
            const container = document.getElementById('topThreeContainer');
            container.innerHTML = '';

            message.topThree.forEach((player, index) => {
                const rank = index + 1;
                const emoji = rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉';

                const itemElement = document.createElement('div');
                itemElement.className = 'leaderboard-item top3';
                itemElement.innerHTML = `
                    <div style="font-size: 1.2em;">
                        ${emoji} ${player.name}
                        ${player.id === gameState.userId ? ' (您)' : ''}
                    </div>
                    <div style="font-size: 1.2em; font-weight: bold;">
                        ${player.score} 分
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }

        // 切換畫面
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
            });

            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                gameState.currentScreen = screenName;
            }
        }

        // 清除所有計時器
        function clearAllTimers() {
            gameState.timers.forEach(timer => clearInterval(timer));
            gameState.timers = [];
            gameState.localTimers.forEach(timer => clearInterval(timer));
            gameState.localTimers = [];
        }

        // 再玩一次
        function playAgain() {
            sessionStorage.removeItem('gameUserId');
            window.location.reload();
        }

        // 回到主頁
        function goHome() {
            ws.close();
            window.location.href = '/home';
        }

        // 頁面卸載時關閉連接
        window.addEventListener('beforeunload', () => {
            ws.close();
        });

        // 初始化
        init();
    </script>
</body>
</html>