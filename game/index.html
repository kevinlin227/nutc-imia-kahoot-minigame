<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot éŠæˆ²</title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
    <div class="container">
        <!-- ç­‰å¾…ç•«é¢ -->
        <div id="waitingScreen" class="waiting-screen">
            <h1>ğŸ® ç­‰å¾…éŠæˆ²é–‹å§‹</h1>
            <p id="playerWelcome" style="font-size: 1.2em; color: #667eea; margin-bottom: 20px;"></p>

            <div id="connectionStatus" style="margin: 20px 0;">
                <div class="status-indicator online"></div>
                <span>å·²é€£æ¥åˆ°éŠæˆ²ä¼ºæœå™¨</span>
            </div>

            <div id="usersList" class="users-list">
                <h3>åƒèˆ‡è€…åˆ—è¡¨ <span id="playerCount" class="player-count">(0)</span></h3>
                <div id="usersContainer" class="users-container"></div>
                <div id="morePlayersIndicator" class="more-players hidden">
                    é‚„æœ‰æ›´å¤šç©å®¶...
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                <p style="color: #666;">ç­‰å¾…ç®¡ç†å“¡é–‹å§‹éŠæˆ²...</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">
                    é¡Œç›®å·²é è¼‰å®Œæˆï¼Œæ–·ç·šå¾Œå¯è‡ªå‹•é‡é€£
                </p>
            </div>
        </div>

        <!-- éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚ -->
        <div id="startCountdownScreen" class="hidden">
            <h1>ğŸš€ éŠæˆ²å³å°‡é–‹å§‹</h1>
            <div id="startCountdown" class="countdown">3</div>
            <p style="color: #666;">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
        </div>

        <!-- éŠæˆ²é€²è¡Œç•«é¢ -->
        <div id="gameScreen" class="game-screen hidden">
            <div id="gameHeader" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="questionCounter" style="color: #667eea; font-weight: bold;"></div>
                    <div id="playerScore" class="score-display">åˆ†æ•¸: 0</div>
                </div>
                <div id="gameTimer" class="timer">10</div>
            </div>

            <div id="questionContainer" class="question-container">
                <div id="questionText" class="question"></div>
                <div id="optionsContainer" class="options"></div>
            </div>

            <div id="answerStatus" style="margin-top: 20px; color: #666;">
                <span id="answerIndicator"></span>
            </div>
        </div>

        <!-- é¡Œç›®çµæœç•«é¢ -->
        <div id="resultsScreen" class="results-screen hidden">
            <h2>ğŸ“Š é¡Œç›®çµæœ</h2>

            <div id="answerResult" style="margin: 30px 0;">
                <div id="correctAnswerDisplay" style="margin-bottom: 15px;"></div>
                <div id="userAnswerDisplay"></div>
            </div>

            <div id="scoreUpdate" style="margin: 20px 0;">
                <div id="currentScore" class="score-display"></div>
                <div id="currentRank" class="rank-display"></div>
                <div id="rankGap" style="color: #999; font-size: 14px;"></div>
            </div>

            <div id="miniLeaderboard" class="leaderboard">
                <h3>ç•¶å‰æ’è¡Œæ¦œ</h3>
                <div id="leaderboardContainer"></div>
            </div>

            <div style="margin-top: 20px; color: #666;">
                ç­‰å¾…é€²å…¥ä¸‹ä¸€é¡Œ...
            </div>
        </div>

        <!-- ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚ -->
        <div id="nextQuestionScreen" class="hidden">
            <h2>â¡ï¸ ä¸‹ä¸€é¡Œæº–å‚™ä¸­</h2>
            <div id="nextCountdown" class="countdown">3</div>
        </div>

        <!-- æœ€çµ‚çµæœç•«é¢ -->
        <div id="finalScreen" class="final-screen hidden">
            <h1>ğŸ‰ éŠæˆ²çµæŸ</h1>

            <div id="finalResult" style="margin: 30px 0;">
                <div id="finalScore" class="score-display"></div>
                <div id="finalRank" class="rank-display"></div>
            </div>

            <div id="topThree" style="margin: 30px 0;">
                <h2>ğŸ† å‰ä¸‰å</h2>
                <div id="topThreeContainer"></div>
            </div>

            <div style="margin-top: 30px;">
                <button onclick="playAgain()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
                <button onclick="goHome()" style="background: #6c757d;">ğŸ  å›åˆ°ä¸»é </button>
            </div>
        </div>
    </div>

    <script src="/public/js/common.js"></script>
    <script>
        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            currentScreen: 'waiting',
            userId: null,
            questions: [],
            totalQuestions: 0,
            currentQuestion: 0,
            selectedAnswer: null,
            questionStartTime: null,
            timers: [],
            localTimers: [] // å®¢æˆ¶ç«¯è¨ˆæ™‚å™¨
        };

        // WebSocketé€£æ¥
        const ws = new GameWebSocket();

        // DOMå…ƒç´ 
        const screens = {
            waiting: document.getElementById('waitingScreen'),
            startCountdown: document.getElementById('startCountdownScreen'),
            game: document.getElementById('gameScreen'),
            results: document.getElementById('resultsScreen'),
            nextQuestion: document.getElementById('nextQuestionScreen'),
            final: document.getElementById('finalScreen')
        };

        // åˆå§‹åŒ–
        function init() {
            console.log('éŠæˆ²é é¢åˆå§‹åŒ–é–‹å§‹');
            const urlParams = new URLSearchParams(window.location.search);
            const playerName = urlParams.get('name') || sessionStorage.getItem('playerName');

            console.log('ç©å®¶åç¨±:', playerName);

            if (!playerName) {
                console.log('æ²’æœ‰ç©å®¶åç¨±ï¼Œé‡å®šå‘åˆ°ä¸»é ');
                window.location.href = '/home';
                return;
            }

            document.getElementById('playerWelcome').textContent = `æ­¡è¿, ${playerName}!`;

            // è¨­ç½®WebSocketäº‹ä»¶è™•ç†
            ws.onopen = () => {
                console.log('WebSocketé€£æ¥æˆåŠŸï¼Œç™¼é€åŠ å…¥è«‹æ±‚');
                updateConnectionStatus(true);
                ws.send({
                    type: 'join',
                    name: playerName
                });
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
            };

            // è¨»å†Šè¨Šæ¯è™•ç†å™¨
            ws.on('connected', handleConnected);
            ws.on('reconnected', handleReconnected);
            ws.on('users_update', handleUsersUpdate);
            ws.on('game_starting', handleGameStarting);
            ws.on('question_start', handleQuestionStart);
            ws.on('show_results', handleShowResults);
            ws.on('next_question_countdown', handleNextQuestionCountdown);
            ws.on('game_end', handleGameEnd);

            // é€£æ¥WebSocket
            console.log('æº–å‚™é€£æ¥WebSocket');
            ws.connect();
        }

        // é€£æ¥ç‹€æ…‹æ›´æ–°
        function updateConnectionStatus(connected) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = statusIndicator.nextElementSibling;

            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'å·²é€£æ¥åˆ°éŠæˆ²ä¼ºæœå™¨';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'é€£æ¥å·²æ–·é–‹ï¼Œå˜—è©¦é‡é€£ä¸­...';
            }
        }

        // è™•ç†é€£æ¥æˆåŠŸ
        function handleConnected(message) {
            gameState.userId = message.userId;
            gameState.questions = message.questions;
            gameState.totalQuestions = message.totalQuestions;

            showNotification('æˆåŠŸåŠ å…¥éŠæˆ²ï¼', 'success');
        }

        // è™•ç†é‡é€£æˆåŠŸ
        function handleReconnected(message) {
            gameState.userId = message.userId;
            gameState.totalQuestions = message.totalQuestions;

            // æ ¹æ“šç•¶å‰éŠæˆ²ç‹€æ…‹åˆ‡æ›ç•«é¢
            if (message.gameStatus === 'playing') {
                if (message.showingResults) {
                    // å¦‚æœåœ¨é¡¯ç¤ºçµæœï¼Œåˆ‡æ›åˆ°çµæœç•«é¢
                    switchScreen('results');
                } else {
                    // å¦‚æœåœ¨é€²è¡ŒéŠæˆ²ï¼Œåˆ‡æ›åˆ°éŠæˆ²ç•«é¢
                    switchScreen('game');
                    loadQuestion(message.currentQuestion);
                }
            }

            showNotification('é‡é€£æˆåŠŸï¼', 'success');
        }

        // è™•ç†ç”¨æˆ¶åˆ—è¡¨æ›´æ–°
        function handleUsersUpdate(message) {
            const container = document.getElementById('usersContainer');
            const playerCountElement = document.getElementById('playerCount');
            const moreIndicator = document.getElementById('morePlayersIndicator');

            // æ›´æ–°ç©å®¶ç¸½æ•¸
            playerCountElement.textContent = `(${message.users.length})`;

            container.innerHTML = '';

            // é™åˆ¶é¡¯ç¤ºçš„ç©å®¶æ•¸é‡ï¼Œé¿å…åˆ—è¡¨éé•·
            const maxDisplayUsers = 10;
            const displayUsers = message.users.slice(0, maxDisplayUsers);
            const hasMore = message.users.length > maxDisplayUsers;

            // ç¢ºä¿ç•¶å‰ç”¨æˆ¶å§‹çµ‚é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­
            let currentUserShown = false;
            const currentUserIndex = message.users.findIndex(user => user.id === gameState.userId);

            if (currentUserIndex >= maxDisplayUsers) {
                // å¦‚æœç•¶å‰ç”¨æˆ¶ä¸åœ¨å‰10åä¸­ï¼Œæ›¿æ›æœ€å¾Œä¸€å€‹ä½ç½®
                displayUsers[maxDisplayUsers - 1] = message.users[currentUserIndex];
                currentUserShown = true;
            }

            displayUsers.forEach((user, index) => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.connected ? '' : 'offline'}`;

                const isCurrentUser = user.id === gameState.userId;
                const rankDisplay = currentUserIndex >= 0 && currentUserIndex >= maxDisplayUsers && isCurrentUser
                    ? `#${currentUserIndex + 1}`
                    : `#${index + 1}`;

                userElement.innerHTML = `
                    <div class="user-info">
                        <span class="status-indicator ${user.connected ? 'online' : 'offline'}"></span>
                        <span class="user-rank">${rankDisplay}</span>
                        <span class="user-name">${user.name} ${isCurrentUser ? '(æ‚¨)' : ''}</span>
                    </div>
                    <div class="user-score">
                        ${user.score} åˆ†
                    </div>
                `;

                if (isCurrentUser) {
                    userElement.classList.add('current-user');
                }

                container.appendChild(userElement);
            });

            // é¡¯ç¤ºæˆ–éš±è—"æ›´å¤šç©å®¶"æŒ‡ç¤ºå™¨
            if (hasMore) {
                moreIndicator.classList.remove('hidden');
                moreIndicator.textContent = `é‚„æœ‰ ${message.users.length - maxDisplayUsers} ä½ç©å®¶...`;
            } else {
                moreIndicator.classList.add('hidden');
            }
        }

        // è™•ç†éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚ï¼ˆå®¢æˆ¶ç«¯å¯¦ç¾ï¼‰
        function handleGameStarting(message) {
            switchScreen('startCountdown');

            const countdownElement = document.getElementById('startCountdown');
            // ä½¿ç”¨å®¢æˆ¶ç«¯å€’è¨ˆæ™‚ï¼Œ3ç§’å›ºå®š
            startClientCountdown(countdownElement, 3, () => {
                // å€’è¨ˆæ™‚çµæŸå¾Œç­‰å¾…ç¬¬ä¸€é¡Œ
                console.log('éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚å®Œæˆï¼Œç­‰å¾…ç¬¬ä¸€é¡Œ');
            });
        }

        // è™•ç†é¡Œç›®é–‹å§‹
        function handleQuestionStart(message) {
            gameState.currentQuestion = message.questionIndex;
            gameState.questionStartTime = Date.now(); // ä½¿ç”¨æœ¬åœ°æ™‚é–“
            gameState.selectedAnswer = null;

            switchScreen('game');
            loadQuestion(message.questionIndex);
            // ä½¿ç”¨å®¢æˆ¶ç«¯10ç§’è¨ˆæ™‚å™¨
            startQuestionTimer(10);
        }

        // è¼‰å…¥é¡Œç›®
        function loadQuestion(questionIndex) {
            const question = gameState.questions[questionIndex];

            document.getElementById('questionCounter').textContent =
                `ç¬¬ ${questionIndex + 1} é¡Œ / å…± ${gameState.totalQuestions} é¡Œ`;

            document.getElementById('questionText').textContent = question.question;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(index));
                optionsContainer.appendChild(optionElement);
            });

            document.getElementById('answerIndicator').textContent = '';
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(answerIndex) {
            if (gameState.selectedAnswer !== null) return;

            gameState.selectedAnswer = answerIndex;
            const timeSpent = Date.now() - gameState.questionStartTime;

            // è¦–è¦ºåé¥‹
            const options = document.querySelectorAll('.option');
            options[answerIndex].classList.add('selected');
            options.forEach(option => option.style.pointerEvents = 'none');

            document.getElementById('answerIndicator').textContent = 'ç­”æ¡ˆå·²æäº¤ï¼Œç­‰å¾…çµæœ...';

            // ç™¼é€ç­”æ¡ˆåˆ°ä¼ºæœå™¨
            ws.send({
                type: 'answer',
                questionIndex: gameState.currentQuestion,
                answer: answerIndex,
                timeSpent: timeSpent
            });
        }

        // å®¢æˆ¶ç«¯é€šç”¨å€’è¨ˆæ™‚å‡½æ•¸
        function startClientCountdown(element, seconds, onComplete) {
            element.textContent = seconds;

            const timer = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(timer);
                    onComplete && onComplete();
                } else {
                    element.textContent = seconds;
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // å®¢æˆ¶ç«¯é¡Œç›®è¨ˆæ™‚å™¨
        function startQuestionTimer(duration) {
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = duration;
            timerElement.style.color = '';
            timerElement.style.animation = '';

            let remaining = duration;

            const timer = setInterval(() => {
                remaining--;
                timerElement.textContent = remaining;

                // æ™‚é–“å¿«ç”¨å®Œæ™‚çš„è¦–è¦ºæ•ˆæœ
                if (remaining <= 3) {
                    timerElement.style.color = '#dc3545';
                    timerElement.style.animation = 'pulse 0.5s infinite';
                }

                if (remaining <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = 'æ™‚é–“åˆ°!';
                    timerElement.style.color = '#dc3545';

                    // å¦‚æœé‚„æ²’é¸æ“‡ï¼Œè‡ªå‹•æäº¤æœªä½œç­”ä¸¦ç¦ç”¨é¸é …
                    if (gameState.selectedAnswer === null) {
                        document.getElementById('answerIndicator').textContent = 'æ™‚é–“åˆ°ï¼ç­‰å¾…çµæœ...';
                        const options = document.querySelectorAll('.option');
                        options.forEach(option => option.style.pointerEvents = 'none');

                            // ç™¼é€è¶…æ™‚ä¿¡è™Ÿåˆ°ä¼ºæœå™¨
                        ws.send({
                            type: 'timeout',
                            questionIndex: gameState.currentQuestion
                        });
                    }
                }
            }, 1000);

            gameState.localTimers.push(timer);
            return timer;
        }

        // è™•ç†çµæœé¡¯ç¤º
        function handleShowResults(message) {
            clearAllTimers();
            switchScreen('results');

            const question = gameState.questions[gameState.currentQuestion];

            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            document.getElementById('correctAnswerDisplay').innerHTML =
                `<div style="color: #28a745; font-weight: bold; font-size: 1.2em;">
                    æ­£ç¢ºç­”æ¡ˆ: ${question.options[message.correctAnswer]}
                </div>`;

            // é¡¯ç¤ºç”¨æˆ¶ç­”æ¡ˆ
            if (message.userAnswer !== null) {
                const isCorrect = message.userAnswer === message.correctAnswer;
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        æ‚¨çš„ç­”æ¡ˆ: ${question.options[message.userAnswer]} ${isCorrect ? 'âœ“' : 'âœ—'}
                    </div>`;
            } else {
                document.getElementById('userAnswerDisplay').innerHTML =
                    `<div style="color: #999;">æ‚¨æœªä½œç­”æˆ–é‡é€£éŒ¯éæ­¤é¡Œ</div>`;
            }

            // é¡¯ç¤ºåˆ†æ•¸å’Œæ’å
            document.getElementById('currentScore').textContent = `åˆ†æ•¸: ${message.score}`;
            document.getElementById('currentRank').textContent = `æ’å: ç¬¬ ${message.rank} å`;

            if (message.gap > 0) {
                document.getElementById('rankGap').textContent =
                    `è·é›¢å‰ä¸€åé‚„å·® ${message.gap} åˆ†`;
            } else {
                document.getElementById('rankGap').textContent = '';
            }

            // é¡¯ç¤ºæ’è¡Œæ¦œ
            displayLeaderboard(message.leaderboard);
        }

        // é¡¯ç¤ºæ’è¡Œæ¦œ
        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '';

            leaderboard.slice(0, 5).forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `leaderboard-item ${item.rank <= 3 ? 'top3' : ''}`;

                const rankEmoji = item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : item.rank === 3 ? 'ğŸ¥‰' : '';

                itemElement.innerHTML = `
                    <div>
                        ${rankEmoji} ${item.rank}. ${item.name}
                        ${item.id === gameState.userId ? ' (æ‚¨)' : ''}
                    </div>
                    <div style="font-weight: bold;">
                        ${item.score} åˆ†
                    </div>
                `;

                container.appendChild(itemElement);
            });
        }

        // è™•ç†ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚ï¼ˆå®¢æˆ¶ç«¯å¯¦ç¾ï¼‰
        function handleNextQuestionCountdown(message) {
            switchScreen('nextQuestion');

            const countdownElement = document.getElementById('nextCountdown');
            // ä½¿ç”¨å®¢æˆ¶ç«¯å€’è¨ˆæ™‚ï¼Œ3ç§’å›ºå®š
            startClientCountdown(countdownElement, 3, () => {
                // å€’è¨ˆæ™‚çµæŸå¾Œç­‰å¾…ä¸‹ä¸€é¡Œ
                console.log('ä¸‹ä¸€é¡Œå€’è¨ˆæ™‚å®Œæˆ');
            });
        }

        // è™•ç†éŠæˆ²çµæŸ
        function handleGameEnd(message) {
            switchScreen('final');

            document.getElementById('finalScore').textContent = `æœ€çµ‚åˆ†æ•¸: ${message.finalScore}`;
            document.getElementById('finalRank').textContent = `æœ€çµ‚æ’å: ç¬¬ ${message.finalRank} å`;

            // é¡¯ç¤ºå‰ä¸‰å
            const container = document.getElementById('topThreeContainer');
            container.innerHTML = '';

            message.topThree.forEach((player, index) => {
                const rank = index + 1;
                const emoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';

                const itemElement = document.createElement('div');
                itemElement.className = 'leaderboard-item top3';
                itemElement.innerHTML = `
                    <div style="font-size: 1.2em;">
                        ${emoji} ${player.name}
                        ${player.id === gameState.userId ? ' (æ‚¨)' : ''}
                    </div>
                    <div style="font-size: 1.2em; font-weight: bold;">
                        ${player.score} åˆ†
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }

        // åˆ‡æ›ç•«é¢
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
            });

            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                gameState.currentScreen = screenName;
            }
        }

        // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
        function clearAllTimers() {
            gameState.timers.forEach(timer => clearInterval(timer));
            gameState.timers = [];
            gameState.localTimers.forEach(timer => clearInterval(timer));
            gameState.localTimers = [];
        }

        // å†ç©ä¸€æ¬¡
        function playAgain() {
            sessionStorage.removeItem('gameUserId');
            window.location.reload();
        }

        // å›åˆ°ä¸»é 
        function goHome() {
            ws.close();
            window.location.href = '/home';
        }

        // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
        window.addEventListener('beforeunload', () => {
            ws.close();
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>