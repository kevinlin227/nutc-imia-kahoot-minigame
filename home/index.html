<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">遊戲 - 主頁</title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
    <div class="container">
        <h1 id="gameTitle">🎯 問答遊戲</h1>
        <p style="margin-bottom: 30px; color: #666; font-size: 1.2em;">
            歡迎來到多人即時問答遊戲！<br>
            輸入您的名字開始遊戲
        </p>

        <form id="joinForm">
            <input
                type="text"
                id="playerName"
                placeholder="請輸入您的名字"
                required
                maxlength="20"
                autocomplete="off"
            >
            <button type="submit" id="joinButton">
                🚀 開始遊戲
            </button>
        </form>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
            <h3 style="color: #333; margin-bottom: 15px;">遊戲規則</h3>
            <ul style="text-align: left; color: #666; line-height: 1.6;">
                <li>每題有4個選項，選擇正確答案獲得分數</li>
                <li>答題速度越快，獲得分數越高</li>
                <li>每題限時10秒作答</li>
                <li>支持斷線重連，不會丟失進度</li>
                <li>最終會顯示排行榜和前三名</li>
            </ul>
        </div>

        <div style="margin-top: 20px;">
            <a href="/admin" style="color: #667eea; text-decoration: none; font-size: 14px;">
                📊 後台管理
            </a>
        </div>
    </div>

    <script>
        // 載入遊戲配置
        async function loadGameConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // 更新頁面標題和遊戲名稱
                document.getElementById('pageTitle').textContent = `${config.gameName} - 主頁`;
                document.getElementById('gameTitle').textContent = `🎯 ${config.gameName}`;
                document.title = `${config.gameName} - 主頁`;
            } catch (error) {
                console.log('無法載入遊戲配置，使用預設值');
            }
        }

        // 載入配置
        loadGameConfig();

        // 檢查重連
        checkForReconnection();

        const form = document.getElementById('joinForm');
        const nameInput = document.getElementById('playerName');
        const joinButton = document.getElementById('joinButton');

        // 檢查是否有保存的名字（僅當前分頁）
        const savedName = sessionStorage.getItem('playerName');
        if (savedName) {
            nameInput.value = savedName;
        }

        // 檢查是否有正在進行的遊戲（斷線重連）
        function checkForReconnection() {
            const savedUserId = localStorage.getItem('gameUserId');
            const savedUserName = localStorage.getItem('gameUserName');

            if (savedUserId && savedUserName) {
                // 顯示重連選項
                showReconnectionOption(savedUserName);
            }
        }

        // 顯示重連選項
        function showReconnectionOption(userName) {
            const form = document.getElementById('joinForm');

            // 創建重連區域
            const reconnectDiv = document.createElement('div');
            reconnectDiv.id = 'reconnectSection';
            reconnectDiv.style.cssText = `
                margin-bottom: 30px;
                padding: 20px;
                background: #e8f5e8;
                border-radius: 15px;
                border-left: 4px solid #28a745;
            `;

            reconnectDiv.innerHTML = `
                <h3 style="color: #155724; margin-top: 0;">🔄 發現未完成的遊戲</h3>
                <p style="color: #155724; margin-bottom: 15px;">
                    玩家: <strong>${userName}</strong><br>
                    您可以重新連接到正在進行的遊戲
                </p>
                <button type="button" id="reconnectBtn" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-right: 10px;
                ">🚀 重新連接</button>
                <button type="button" id="newGameBtn" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                ">🆕 開始新遊戲</button>
            `;

            form.parentNode.insertBefore(reconnectDiv, form);

            // 設置事件監聽器
            document.getElementById('reconnectBtn').addEventListener('click', () => {
                window.location.href = `/game?reconnect=true`;
            });

            document.getElementById('newGameBtn').addEventListener('click', () => {
                // 清除保存的遊戲資料
                localStorage.removeItem('gameUserId');
                localStorage.removeItem('gameUserName');
                reconnectDiv.remove();
            });
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const name = nameInput.value.trim();
            if (!name) {
                alert('請輸入您的名字！');
                return;
            }

            if (name.length > 20) {
                alert('名字長度不能超過20個字符！');
                return;
            }

            // 保存名字（僅當前分頁）
            sessionStorage.setItem('playerName', name);

            // 跳轉到遊戲頁面
            window.location.href = `/game?name=${encodeURIComponent(name)}`;
        });

        // 輸入框焦點
        nameInput.focus();

        // 按Enter鍵提交
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                form.requestSubmit();
            }
        });

        // 檢查伺服器連接狀態
        fetch('/')
            .then(() => {
                console.log('伺服器連接正常');
            })
            .catch(() => {
                const warning = document.createElement('div');
                warning.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404;
                                padding: 15px; border-radius: 10px; margin-top: 20px;">
                        ⚠️ 無法連接到遊戲伺服器，請確認伺服器是否運行中
                    </div>
                `;
                document.querySelector('.container').appendChild(warning);
            });
    </script>
</body>
</html>