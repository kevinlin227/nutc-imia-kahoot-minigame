<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">éŠæˆ² - ä¸»é </title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
    <div class="container">
        <h1 id="gameTitle">ğŸ¯ å•ç­”éŠæˆ²</h1>
        <p id="welcomeText" style="margin-bottom: 30px; color: #666; font-size: 1.2em;">
            æ­¡è¿ä¾†åˆ°å¤šäººå³æ™‚å•ç­”éŠæˆ²ï¼<br>
            è¼¸å…¥æ‚¨çš„åå­—é–‹å§‹éŠæˆ²
        </p>

        <form id="joinForm">
            <input
                type="text"
                id="playerName"
                placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—"
                required
                maxlength="20"
                autocomplete="off"
            >
            <button type="submit" id="joinButton">
                ğŸš€ é–‹å§‹éŠæˆ²
            </button>
        </form>

        <div id="rulesSection" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
            <h3 id="rulesTitle" style="color: #333; margin-bottom: 15px;">éŠæˆ²è¦å‰‡</h3>
            <ul id="rulesList" style="text-align: left; color: #666; line-height: 1.6;">
                <li>æ¯é¡Œæœ‰4å€‹é¸é …ï¼Œé¸æ“‡æ­£ç¢ºç­”æ¡ˆç²å¾—åˆ†æ•¸</li>
                <li>ç­”é¡Œé€Ÿåº¦è¶Šå¿«ï¼Œç²å¾—åˆ†æ•¸è¶Šé«˜</li>
                <li>æ¯é¡Œé™æ™‚10ç§’ä½œç­”</li>
            </ul>
        </div>

    </div>

    <script>
        // è¼‰å…¥éŠæˆ²é…ç½®
        async function loadGameConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // æ›´æ–°é é¢æ¨™é¡Œå’ŒéŠæˆ²åç¨±
                document.getElementById('pageTitle').textContent = `${config.gameName} - ä¸»é `;
                document.getElementById('gameTitle').textContent = `ğŸ¯ ${config.gameName}`;
                document.title = `${config.gameName} - ä¸»é `;

                // æ›´æ–°homeé é¢æ–‡å­—
                if (config.ui && config.ui.home) {
                    const homeConfig = config.ui.home;

                    // æ›´æ–°æ­¡è¿è¨Šæ¯
                    document.getElementById('welcomeText').innerHTML =
                        `${homeConfig.welcomeMessage}<br>${homeConfig.welcomeSubMessage}`;

                    // æ›´æ–°è¼¸å…¥æ¡†placeholder
                    document.getElementById('playerName').placeholder = homeConfig.nameInputPlaceholder;

                    // æ›´æ–°é–‹å§‹æŒ‰éˆ•æ–‡å­—
                    document.getElementById('joinButton').innerHTML = homeConfig.startButtonText;

                    // æ›´æ–°éŠæˆ²è¦å‰‡
                    document.getElementById('rulesTitle').textContent = homeConfig.rulesTitle;

                    const rulesList = document.getElementById('rulesList');
                    rulesList.innerHTML = '';
                    homeConfig.rules.forEach(rule => {
                        const li = document.createElement('li');
                        li.textContent = rule;
                        rulesList.appendChild(li);
                    });
                }
            } catch (error) {
                console.log('ç„¡æ³•è¼‰å…¥éŠæˆ²é…ç½®ï¼Œä½¿ç”¨é è¨­å€¼');
            }
        }

        // è¼‰å…¥é…ç½®
        loadGameConfig();

        // æª¢æŸ¥é‡é€£
        checkForReconnection();

        const form = document.getElementById('joinForm');
        const nameInput = document.getElementById('playerName');
        const joinButton = document.getElementById('joinButton');

        // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„åå­—ï¼ˆåƒ…ç•¶å‰åˆ†é ï¼‰
        const savedName = sessionStorage.getItem('playerName');
        if (savedName) {
            nameInput.value = savedName;
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨é€²è¡Œçš„éŠæˆ²ï¼ˆæ–·ç·šé‡é€£ï¼‰
        function checkForReconnection() {
            const savedUserId = localStorage.getItem('gameUserId');
            const savedUserName = localStorage.getItem('gameUserName');

            if (savedUserId && savedUserName) {
                // é¡¯ç¤ºé‡é€£é¸é …
                showReconnectionOption(savedUserName);
            }
        }

        // é¡¯ç¤ºé‡é€£é¸é …
        async function showReconnectionOption(userName) {
            const form = document.getElementById('joinForm');

            // æª¢æŸ¥userNameæ˜¯å¦ç‚ºæœ‰æ•ˆå€¼
            const displayName = userName && userName !== 'undefined' ? userName : 'æœªçŸ¥ç©å®¶';

            // è¼‰å…¥é‡é€£æ–‡å­—é…ç½®
            let reconnectConfig = {
                title: "ğŸ”„ ç™¼ç¾æœªå®Œæˆçš„éŠæˆ²",
                messageTemplate: "ç©å®¶: <strong>{{playerName}}</strong><br>æ‚¨å¯ä»¥é‡æ–°é€£æ¥åˆ°æ­£åœ¨é€²è¡Œçš„éŠæˆ²",
                reconnectButtonText: "ğŸš€ é‡æ–°é€£æ¥",
                newGameHint: "å¦‚è¦é–‹å§‹æ–°éŠæˆ²ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„è¼¸å…¥æ¡†é‡æ–°è¼¸å…¥åå­—"
            };

            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (config.ui && config.ui.home && config.ui.home.reconnect) {
                    reconnectConfig = config.ui.home.reconnect;
                }
            } catch (error) {
                console.log('ç„¡æ³•è¼‰å…¥é‡é€£é…ç½®ï¼Œä½¿ç”¨é è¨­å€¼');
            }

            // è™•ç†è¨Šæ¯æ¨¡æ¿
            const message = reconnectConfig.messageTemplate.replace('{{playerName}}', displayName);

            // å‰µå»ºé‡é€£å€åŸŸ
            const reconnectDiv = document.createElement('div');
            reconnectDiv.id = 'reconnectSection';
            reconnectDiv.style.cssText = `
                margin-bottom: 30px;
                padding: 20px;
                background: #e8f5e8;
                border-radius: 15px;
                border-left: 4px solid #28a745;
            `;

            reconnectDiv.innerHTML = `
                <h3 style="color: #155724; margin-top: 0;">${reconnectConfig.title}</h3>
                <p style="color: #155724; margin-bottom: 15px;">
                    ${message}
                </p>
                <button type="button" id="reconnectBtn" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 15px 25px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                ">${reconnectConfig.reconnectButtonText}</button>
                <p style="color: #666; margin-top: 15px; font-size: 14px;">
                    ${reconnectConfig.newGameHint}
                </p>
            `;

            form.parentNode.insertBefore(reconnectDiv, form);

            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            document.getElementById('reconnectBtn').addEventListener('click', () => {
                window.location.href = `/game?reconnect=true`;
            });
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const name = nameInput.value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼');
                return;
            }

            if (name.length > 20) {
                alert('åå­—é•·åº¦ä¸èƒ½è¶…é20å€‹å­—ç¬¦ï¼');
                return;
            }

            // æ¸…é™¤èˆŠçš„éŠæˆ²è³‡æ–™ï¼Œå› ç‚ºè¦é–‹å§‹æ–°éŠæˆ²
            localStorage.removeItem('gameUserId');
            localStorage.removeItem('gameUserName');

            // ä¿å­˜åå­—ï¼ˆåƒ…ç•¶å‰åˆ†é ï¼‰
            sessionStorage.setItem('playerName', name);

            // ç§»é™¤é‡é€£æç¤ºå€åŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const reconnectSection = document.getElementById('reconnectSection');
            if (reconnectSection) {
                reconnectSection.remove();
            }

            // è·³è½‰åˆ°éŠæˆ²é é¢
            window.location.href = `/game?name=${encodeURIComponent(name)}`;
        });

        // è¼¸å…¥æ¡†ç„¦é»
        nameInput.focus();

        // æŒ‰Enteréµæäº¤
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                form.requestSubmit();
            }
        });

        // æª¢æŸ¥ä¼ºæœå™¨é€£æ¥ç‹€æ…‹
        fetch('/')
            .then(() => {
                console.log('ä¼ºæœå™¨é€£æ¥æ­£å¸¸');
            })
            .catch(() => {
                const warning = document.createElement('div');
                warning.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404;
                                padding: 15px; border-radius: 10px; margin-top: 20px;">
                        âš ï¸ ç„¡æ³•é€£æ¥åˆ°éŠæˆ²ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦é‹è¡Œä¸­
                    </div>
                `;
                document.querySelector('.container').appendChild(warning);
            });
    </script>
</body>
</html>