<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot 遊戲 - 後台管理</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .control-buttons button {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            font-size: 16px;
        }

        .admin-users-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
        }

        .admin-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .admin-user-item.offline {
            opacity: 0.5;
            border-left-color: #dc3545;
        }

        .questions-preview {
            margin-top: 30px;
        }

        .question-item {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .question-option {
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .question-option.correct {
            background: #d4edda;
            border-color: #28a745;
            font-weight: bold;
        }

        .game-log {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }

        .monitoring-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .countdown-display {
            background: #667eea;
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            display: none;
        }

        .countdown-display.active {
            display: block;
        }

        .answer-stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .answer-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .option-label {
            width: 60px;
            font-weight: bold;
        }

        .option-bar {
            flex: 1;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }

        .option-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .option-fill.option-a { background: #e74c3c; }
        .option-fill.option-b { background: #3498db; }
        .option-fill.option-c { background: #f39c12; }
        .option-fill.option-d { background: #27ae60; }

        .response-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .response-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-entry.warning {
            background: #fff3cd;
            color: #856404;
        }

        .log-entry.error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .admin-container {
                margin: 10px;
                padding: 10px;
            }

            .status-panel {
                grid-template-columns: 1fr;
            }

            .monitoring-panel {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .control-buttons button {
                min-width: auto;
            }

            .countdown-display {
                font-size: 1.5em;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-panel">
            <h1>🎮 Kahoot 遊戲後台管理</h1>

            <!-- 遊戲狀態總覽 -->
            <div class="status-panel">
                <div class="status-card">
                    <h3>遊戲狀態</h3>
                    <div id="gameStatus" class="value">等待中</div>
                </div>
                <div class="status-card">
                    <h3>參與人數</h3>
                    <div id="playerCount" class="value">0</div>
                </div>
                <div class="status-card">
                    <h3>當前題目</h3>
                    <div id="currentQuestion" class="value">-</div>
                </div>
            </div>

            <!-- 即時監控面板 -->
            <div class="monitoring-panel">
                <!-- 倒計時顯示 -->
                <div>
                    <div id="gameCountdown" class="countdown-display">
                        遊戲開始倒計時: <span id="gameCountdownValue">3</span>
                    </div>
                    <div id="questionCountdown" class="countdown-display">
                        題目倒計時: <span id="questionCountdownValue">10</span>
                    </div>
                    <div id="nextQuestionCountdown" class="countdown-display">
                        下一題倒計時: <span id="nextQuestionCountdownValue">3</span>
                    </div>
                </div>

                <!-- 作答統計 -->
                <div class="answer-stats">
                    <h3>即時作答統計</h3>
                    <div id="answerStatsContent">
                        <p style="text-align: center; color: #666;">等待題目開始...</p>
                    </div>
                </div>
            </div>

            <!-- 控制按鈕 -->
            <div class="admin-controls">
                <h3>遊戲控制</h3>
                <div class="control-buttons">
                    <button id="startGameBtn" onclick="startGame()">
                        🚀 開始遊戲
                    </button>
                    <button id="showResultsBtn" onclick="showResults()" disabled>
                        📊 顯示結果
                    </button>
                    <button id="nextQuestionBtn" onclick="nextQuestion()" disabled>
                        ➡️ 下一題
                    </button>
                    <button id="endGameBtn" onclick="endGame()" disabled>
                        🏁 結束遊戲
                    </button>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="resetGame()" style="background: #dc3545;">
                        🔄 重置遊戲
                    </button>
                    <button onclick="refreshData()">
                        🔄 刷新數據
                    </button>
                </div>
            </div>

            <!-- 參與者列表 -->
            <div>
                <h3>參與者列表</h3>
                <div id="adminUsersList" class="admin-users-list">
                    <p style="text-align: center; color: #666;">暫無參與者</p>
                </div>
            </div>
        </div>

        <!-- 題目預覽 -->
        <div class="admin-panel">
            <h3>題目預覽</h3>
            <div id="questionsPreview" class="questions-preview"></div>
        </div>

        <!-- 遊戲日誌 -->
        <div class="admin-panel">
            <h3>遊戲日誌</h3>
            <div id="gameLog" class="game-log">
                <div class="log-entry info">系統啟動，等待連接...</div>
            </div>
        </div>

        <!-- 返回主頁 -->
        <div style="text-align: center; margin-top: 20px;">
            <a href="/home" style="color: #667eea; text-decoration: none;">
                🏠 返回主頁
            </a>
        </div>
    </div>

    <script src="/public/js/common.js"></script>
    <script>
        // 管理後台狀態
        const adminState = {
            gameStatus: 'waiting',
            users: [],
            currentQuestion: -1,
            questions: []
        };

        // WebSocket連接
        const ws = new GameWebSocket();

        // 初始化
        function init() {
            // 設置WebSocket事件處理
            ws.onopen = () => {
                addLog('已連接到遊戲伺服器', 'info');
                // 發送管理員連接請求
                ws.send({ type: 'admin_connect' });
            };

            ws.onclose = () => {
                addLog('與伺服器的連接已斷開', 'error');
            };

            ws.onerror = (error) => {
                addLog('連接錯誤: ' + error, 'error');
            };

            // 註冊訊息處理器
            ws.on('admin_connected', handleAdminConnected);
            ws.on('users_update', handleUsersUpdate);
            ws.on('game_starting', handleGameStarting);
            ws.on('question_start', handleQuestionStart);
            ws.on('show_results', handleShowResults);
            ws.on('next_question_countdown', handleNextQuestionCountdown);
            ws.on('game_end', handleGameEnd);
            ws.on('admin_game_starting', handleAdminGameStarting);
            ws.on('admin_question_start', handleAdminQuestionStart);
            ws.on('admin_next_question_countdown', handleAdminNextQuestionCountdown);
            ws.on('answer_stats', handleAnswerStats);
            ws.on('admin_countdown_update', handleAdminCountdownUpdate);
            ws.on('admin_time_up', handleAdminTimeUp);

            // 連接WebSocket
            ws.connect();

            // 載入題目預覽
            loadQuestionsPreview();

            // 定期刷新數據
            setInterval(refreshData, 5000);
        }


        // 載入題目預覽
        function loadQuestionsPreview() {
            // 由於我們在伺服器端定義了題目，這裡直接展示
            const questions = [
                {
                    question: "JavaScript中哪個方法用於添加數組元素？",
                    options: ["push()", "add()", "insert()", "append()"],
                    correctAnswer: 0
                },
                {
                    question: "HTML中哪個標籤用於創建超連結？",
                    options: ["<link>", "<href>", "<a>", "<url>"],
                    correctAnswer: 2
                },
                {
                    question: "CSS中哪個屬性用於設置文字顏色？",
                    options: ["text-color", "font-color", "color", "background-color"],
                    correctAnswer: 2
                }
            ];

            const container = document.getElementById('questionsPreview');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question-item';

                questionElement.innerHTML = `
                    <h4>第 ${index + 1} 題</h4>
                    <p style="font-size: 1.1em; margin: 10px 0; font-weight: bold;">
                        ${q.question}
                    </p>
                    <div class="question-options">
                        ${q.options.map((option, optIndex) => `
                            <div class="question-option ${optIndex === q.correctAnswer ? 'correct' : ''}">
                                ${String.fromCharCode(65 + optIndex)}. ${option}
                                ${optIndex === q.correctAnswer ? ' ✓' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(questionElement);
            });
        }

        // 處理管理員連接成功
        function handleAdminConnected(message) {
            adminState.gameStatus = message.gameStatus;
            adminState.currentQuestion = message.currentQuestion;
            adminState.users = message.users;

            // 更新所有顯示
            updateGameStatus();
            updateCurrentQuestion();
            updatePlayerCount();
            updateUsersDisplay();
            updateControlButtons();

            addLog('管理員連接成功，已同步遊戲狀態', 'info');
        }

        // 處理用戶列表更新
        function handleUsersUpdate(message) {
            adminState.users = message.users;
            updateUsersDisplay();
            updatePlayerCount();
            addLog(`用戶列表更新: ${message.users.length} 人在線`, 'info');
        }

        // 處理遊戲開始
        function handleGameStarting(message) {
            adminState.gameStatus = 'starting';
            updateGameStatus();
            updateControlButtons();
            addLog('遊戲開始倒計時', 'info');
        }

        // 處理題目開始
        function handleQuestionStart(message) {
            adminState.gameStatus = 'playing';
            adminState.currentQuestion = message.questionIndex;
            updateGameStatus();
            updateCurrentQuestion();
            updateControlButtons();
            addLog(`第 ${message.questionIndex + 1} 題開始`, 'info');
        }

        // 處理結果顯示
        function handleShowResults(message) {
            adminState.gameStatus = 'showing_results';
            updateGameStatus();
            updateControlButtons();
            addLog(`顯示第 ${adminState.currentQuestion + 1} 題結果`, 'info');
        }

        // 處理下一題倒計時
        function handleNextQuestionCountdown(message) {
            addLog('下一題倒計時開始', 'info');
        }

        // 處理遊戲結束
        function handleGameEnd(message) {
            adminState.gameStatus = 'finished';
            updateGameStatus();
            updateControlButtons();
            hideAllCountdowns();
            addLog('遊戲結束', 'info');
        }

        // 處理管理員遊戲開始倒計時
        function handleAdminGameStarting(message) {
            showGameCountdown(message.countdown);
        }

        // 處理管理員題目開始
        function handleAdminQuestionStart(message) {
            hideAllCountdowns();
            showQuestionCountdown(message.timeLimit / 1000, true); // 使用服務器時間
            resetAnswerStats();
            addLog(`第 ${message.questionIndex + 1} 題: ${message.question.question}`, 'info');
        }

        // 處理服務器倒計時更新
        function handleAdminCountdownUpdate(message) {
            updateQuestionCountdown(message.remaining);
        }

        // 處理時間到了
        function handleAdminTimeUp(message) {
            updateQuestionCountdown(0);
            updateAnswerStats(message.stats);
            addLog(`第 ${message.questionIndex + 1} 題時間到！`, 'warning');
        }

        // 處理管理員下一題倒計時
        function handleAdminNextQuestionCountdown(message) {
            hideAllCountdowns();
            showNextQuestionCountdown(message.countdown);
        }

        // 處理作答統計更新
        function handleAnswerStats(message) {
            updateAnswerStats(message.stats);
        }

        // 顯示遊戲開始倒計時
        function showGameCountdown(seconds) {
            hideAllCountdowns();
            const countdown = document.getElementById('gameCountdown');
            const valueElement = document.getElementById('gameCountdownValue');

            countdown.classList.add('active');
            valueElement.textContent = seconds;

            const interval = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(interval);
                    countdown.classList.remove('active');
                } else {
                    valueElement.textContent = seconds;
                }
            }, 1000);
        }

        // 顯示題目倒計時
        function showQuestionCountdown(seconds, useServerTime = false) {
            hideAllCountdowns();
            const countdown = document.getElementById('questionCountdown');
            const valueElement = document.getElementById('questionCountdownValue');

            countdown.classList.add('active');
            valueElement.textContent = seconds;

            if (!useServerTime) {
                // 只有在不使用服務器時間時才啟動本地倒計時
                const interval = setInterval(() => {
                    seconds--;
                    if (seconds <= 0) {
                        clearInterval(interval);
                        valueElement.textContent = '時間到!';
                        setTimeout(() => {
                            countdown.classList.remove('active');
                        }, 2000);
                    } else {
                        valueElement.textContent = seconds;
                    }
                }, 1000);
            }
        }

        // 更新題目倒計時（由服務器控制）
        function updateQuestionCountdown(seconds) {
            const valueElement = document.getElementById('questionCountdownValue');
            if (seconds <= 0) {
                valueElement.textContent = '時間到!';
                setTimeout(() => {
                    document.getElementById('questionCountdown').classList.remove('active');
                }, 2000);
            } else {
                valueElement.textContent = seconds;
            }
        }

        // 顯示下一題倒計時
        function showNextQuestionCountdown(seconds) {
            hideAllCountdowns();
            const countdown = document.getElementById('nextQuestionCountdown');
            const valueElement = document.getElementById('nextQuestionCountdownValue');

            countdown.classList.add('active');
            valueElement.textContent = seconds;

            const interval = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(interval);
                    countdown.classList.remove('active');
                } else {
                    valueElement.textContent = seconds;
                }
            }, 1000);
        }

        // 隱藏所有倒計時
        function hideAllCountdowns() {
            document.getElementById('gameCountdown').classList.remove('active');
            document.getElementById('questionCountdown').classList.remove('active');
            document.getElementById('nextQuestionCountdown').classList.remove('active');
        }

        // 重置作答統計
        function resetAnswerStats() {
            const content = document.getElementById('answerStatsContent');
            content.innerHTML = `
                <div class="answer-option">
                    <div class="option-label">A:</div>
                    <div class="option-bar">
                        <div class="option-fill option-a" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="answer-option">
                    <div class="option-label">B:</div>
                    <div class="option-bar">
                        <div class="option-fill option-b" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="answer-option">
                    <div class="option-label">C:</div>
                    <div class="option-bar">
                        <div class="option-fill option-c" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="answer-option">
                    <div class="option-label">D:</div>
                    <div class="option-bar">
                        <div class="option-fill option-d" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="answer-option">
                    <div class="option-label">未答:</div>
                    <div class="option-bar">
                        <div class="option-fill" style="width: 100%; background: #6c757d;">100% (0)</div>
                    </div>
                </div>
                <div class="response-summary">
                    <div class="response-count">0/0</div>
                    <div>已作答人數</div>
                </div>
            `;
        }

        // 更新作答統計
        function updateAnswerStats(stats) {
            const content = document.getElementById('answerStatsContent');
            const options = ['A', 'B', 'C', 'D'];
            const colors = ['option-a', 'option-b', 'option-c', 'option-d'];

            let html = '';

            options.forEach((option, index) => {
                const percentage = stats.answerPercentages[index] || 0;
                const count = stats.answerCounts[index] || 0;

                html += `
                    <div class="answer-option">
                        <div class="option-label">${option}:</div>
                        <div class="option-bar">
                            <div class="option-fill ${colors[index]}" style="width: ${percentage}%">
                                ${percentage}% (${count})
                            </div>
                        </div>
                    </div>
                `;
            });

            // 添加未作答統計
            if (stats.unansweredCount > 0) {
                html += `
                    <div class="answer-option">
                        <div class="option-label">未答:</div>
                        <div class="option-bar">
                            <div class="option-fill" style="width: ${stats.unansweredPercentage}%; background: #6c757d;">
                                ${stats.unansweredPercentage}% (${stats.unansweredCount})
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="response-summary">
                    <div class="response-count">${stats.answeredCount}/${stats.totalUsers}</div>
                    <div>已作答人數</div>
                </div>
            `;

            content.innerHTML = html;
        }

        // 更新用戶顯示
        function updateUsersDisplay() {
            const container = document.getElementById('adminUsersList');

            if (adminState.users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">暫無參與者</p>';
                return;
            }

            container.innerHTML = '';

            // 按分數排序
            const sortedUsers = [...adminState.users].sort((a, b) => b.score - a.score);

            sortedUsers.forEach((user, index) => {
                const userElement = document.createElement('div');
                userElement.className = `admin-user-item ${user.connected ? '' : 'offline'}`;

                userElement.innerHTML = `
                    <div>
                        <div style="font-weight: bold; font-size: 1.1em;">
                            ${index + 1}. ${user.name}
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            ID: ${user.id}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">
                            ${user.score} 分
                        </div>
                        <div style="font-size: 0.9em; color: ${user.connected ? '#28a745' : '#dc3545'};">
                            ${user.connected ? '在線' : '離線'}
                        </div>
                    </div>
                `;

                container.appendChild(userElement);
            });
        }

        // 更新遊戲狀態顯示
        function updateGameStatus() {
            const statusElement = document.getElementById('gameStatus');
            const statusMap = {
                'waiting': '等待中',
                'starting': '開始倒計時',
                'playing': '進行中',
                'showing_results': '顯示結果',
                'finished': '已結束'
            };

            statusElement.textContent = statusMap[adminState.gameStatus] || adminState.gameStatus;
        }

        // 更新參與人數
        function updatePlayerCount() {
            document.getElementById('playerCount').textContent = adminState.users.length;
        }

        // 更新當前題目
        function updateCurrentQuestion() {
            const element = document.getElementById('currentQuestion');
            if (adminState.currentQuestion >= 0) {
                element.textContent = `${adminState.currentQuestion + 1}/3`;
            } else {
                element.textContent = '-';
            }
        }

        // 更新控制按鈕狀態
        function updateControlButtons() {
            const startBtn = document.getElementById('startGameBtn');
            const showResultsBtn = document.getElementById('showResultsBtn');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const endGameBtn = document.getElementById('endGameBtn');

            // 重置所有按鈕
            [startBtn, showResultsBtn, nextQuestionBtn, endGameBtn].forEach(btn => {
                btn.disabled = true;
            });

            switch (adminState.gameStatus) {
                case 'waiting':
                    startBtn.disabled = false;
                    break;

                case 'playing':
                    showResultsBtn.disabled = false;
                    endGameBtn.disabled = false;
                    break;

                case 'showing_results':
                    nextQuestionBtn.disabled = false;
                    endGameBtn.disabled = false;
                    break;

                case 'finished':
                    // 所有按鈕都保持禁用狀態
                    break;
            }
        }

        // 添加日誌
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('gameLog');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // 限制日誌數量
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // 管理員控制函數
        function startGame() {
            if (adminState.users.length === 0) {
                alert('沒有參與者，無法開始遊戲！');
                return;
            }

            ws.send({ type: 'admin_start_game' });
            addLog('管理員啟動遊戲', 'warning');
        }

        function showResults() {
            ws.send({ type: 'admin_show_results' });
            addLog('管理員顯示結果', 'warning');
        }

        function nextQuestion() {
            ws.send({ type: 'admin_next_question' });
            addLog('管理員進入下一題', 'warning');
        }

        function endGame() {
            if (confirm('確定要結束遊戲嗎？')) {
                ws.send({ type: 'admin_end_game' });
                addLog('管理員結束遊戲', 'warning');
            }
        }

        function resetGame() {
            if (confirm('確定要重置遊戲嗎？這將清除所有參與者和進度！')) {
                location.reload();
            }
        }

        function refreshData() {
            // 由於我們通過WebSocket實時更新，這裡只是更新顯示
            updateGameStatus();
            updatePlayerCount();
            updateCurrentQuestion();
            updateControlButtons();
        }

        // 初始化
        init();
    </script>
</body>
</html>